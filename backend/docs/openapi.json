{"openapi":"3.0.3","info":{"title":"Taxi API","description":"API de Taxi","version":"1.0.0"},"components":{"securitySchemes":{"bearerAuth":{"type":"http","scheme":"bearer"}},"schemas":{}},"paths":{"/healthz":{"get":{"operationId":"healthz","security":[],"responses":{"200":{"description":"Default Response"}}}},"/auth/register":{"post":{"operationId":"authRegister","tags":["auth"],"requestBody":{"content":{"application/json":{"schema":{"type":"object","required":["email","password","firstName","lastName","role"],"properties":{"email":{"type":"string","format":"email","example":"driver@taxi.local"},"password":{"type":"string","minLength":6,"example":"123456"},"firstName":{"type":"string","example":"John"},"lastName":{"type":"string","example":"Doe"},"role":{"type":"string","enum":["ADMIN","DRIVER","RIDER"],"example":"DRIVER"}},"additionalProperties":false}}},"required":true},"security":[],"responses":{"201":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"token":{"type":"string"},"refreshToken":{"type":"string"},"user":{"type":"object","properties":{"id":{"type":"string"},"email":{"type":"string"},"role":{"type":"string","enum":["ADMIN","DRIVER","RIDER"]}}}}}}}},"400":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}}}}}}}}},"/auth/login":{"post":{"operationId":"authLogin","tags":["auth"],"requestBody":{"content":{"application/json":{"schema":{"type":"object","required":["email","password"],"properties":{"email":{"type":"string","format":"email","example":"driver@taxi.local"},"password":{"type":"string","minLength":6,"example":"123456"}},"additionalProperties":false}}},"required":true},"security":[],"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"token":{"type":"string"},"refreshToken":{"type":"string"},"user":{"type":"object","properties":{"id":{"type":"string"},"email":{"type":"string"},"role":{"type":"string","enum":["ADMIN","DRIVER","RIDER"]}}}}}}}},"401":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}}}}}},"429":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}}}}}}}}},"/auth/refresh":{"post":{"operationId":"authRefresh","tags":["auth"],"requestBody":{"content":{"application/json":{"schema":{"type":"object","required":["refreshToken"],"properties":{"refreshToken":{"type":"string"}},"additionalProperties":false}}},"required":true},"security":[],"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"token":{"type":"string"},"refreshToken":{"type":"string"}}}}}},"401":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}}}}}}}}},"/auth/logout":{"post":{"operationId":"authLogout","tags":["auth"],"requestBody":{"content":{"application/json":{"schema":{"type":"object","properties":{"refreshToken":{"type":"string"}},"additionalProperties":false}}}},"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"ok":{"type":"boolean"}}}}}}}}},"/auth/me":{"get":{"operationId":"authMe","tags":["auth"],"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"user":{"type":"object","properties":{"id":{"type":"string"},"email":{"type":"string"},"role":{"type":"string","enum":["ADMIN","DRIVER","RIDER"]},"firstName":{"type":"string"},"lastName":{"type":"string"}}}}}}}},"401":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}}}}}}}}},"/drivers/status":{"post":{"operationId":"driverUpdateStatus","summary":"Actualizar estado del driver","tags":["drivers"],"description":"Driver reporta su estado (IDLE/ON_TRIP/etc.). Requiere JWT.","requestBody":{"content":{"application/json":{"schema":{"type":"object","properties":{"lat":{"type":"number","example":-2.17},"lng":{"type":"number","example":-79.92},"status":{"type":"string","enum":["IDLE","ASSIGNED","ARRIVED","ON_TRIP","OFFLINE"],"example":"IDLE"}},"additionalProperties":false}}}},"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"ok":{"type":"boolean"}},"example":{"ok":true}}}}},"401":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Unauthorized"}}}}}}}},"/drivers/location":{"post":{"operationId":"driverUpdateLocation","summary":"Actualizar estado del driver","tags":["drivers"],"description":"Driver reporta su estado (IDLE/ON_TRIP/etc.). Requiere JWT.","requestBody":{"content":{"application/json":{"schema":{"type":"object","properties":{"lat":{"type":"number","example":-2.17},"lng":{"type":"number","example":-79.92},"status":{"type":"string","enum":["IDLE","ASSIGNED","ARRIVED","ON_TRIP","OFFLINE"],"example":"IDLE"}},"additionalProperties":false}}}},"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"ok":{"type":"boolean"}},"example":{"ok":true}}}}},"401":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Unauthorized"}}}}}}}},"/drivers/my-trips/active":{"get":{"operationId":"driverMyTripsActive","summary":"Mis viajes activos","tags":["drivers"],"description":"Lista viajes del driver con estado ACCEPTED/ARRIVED/STARTED.","responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"items":{"type":"array","items":{"type":"object","properties":{"id":{"type":"string"},"status":{"type":"string","enum":["ACCEPTED","ARRIVED","STARTED"]},"pickupLat":{"type":"number"},"pickupLng":{"type":"number"},"dropoffLat":{"type":"number"},"dropoffLng":{"type":"number"},"requestedAt":{"type":"string","format":"date-time"},"preferredMethod":{"type":"string","enum":["CASH","CARD"],"nullable":true}}}}},"example":{"items":[{"id":"trp_123","status":"ACCEPTED","pickupLat":-2.17,"pickupLng":-79.92,"dropoffLat":-2.19,"dropoffLng":-79.89,"requestedAt":"2025-01-01T12:00:00.000Z","preferredMethod":"CARD"}]}}}}},"401":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Unauthorized"}}}}},"403":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Forbidden"}}}}}}}},"/drivers/my-trips/history":{"get":{"operationId":"driverMyTripsHistory","summary":"Mis viajes (historial)","tags":["drivers"],"description":"Lista de viajes completados o cancelados para el driver autenticado.","parameters":[{"schema":{"type":"integer","minimum":1,"maximum":100,"default":20},"in":"query","name":"limit","required":false},{"schema":{"type":"string","nullable":true},"in":"query","name":"cursor","required":false}],"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"items":{"type":"array","items":{"type":"object","properties":{"id":{"type":"string"},"status":{"type":"string","enum":["COMPLETED","CANCELED"]},"pickupLat":{"type":"number"},"pickupLng":{"type":"number"},"dropoffLat":{"type":"number"},"dropoffLng":{"type":"number"},"requestedAt":{"type":"string","format":"date-time"},"completedAt":{"type":"string","format":"date-time","nullable":true},"costUsd":{"type":"number","nullable":true},"currency":{"type":"string","nullable":true}}}},"nextCursor":{"type":"string","nullable":true}}}}}},"401":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Unauthorized"}}}}},"403":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Forbidden"}}}}}}}},"/trips/request":{"post":{"operationId":"tripsRequest","summary":"Solicitar viaje","tags":["Trips"],"description":"Crea un viaje y asigna el conductor disponible mÃ¡s cercano.","requestBody":{"content":{"application/json":{"schema":{"type":"object","required":["city","pickupLat","pickupLng","dropoffLat","dropoffLng","distanceKm","durationMin"],"properties":{"city":{"type":"string","example":"Guayaquil"},"pickupLat":{"type":"number","example":-2.17},"pickupLng":{"type":"number","example":-79.92},"dropoffLat":{"type":"number","example":-2.19},"dropoffLng":{"type":"number","example":-79.89},"pickupAddress":{"type":"string","nullable":true},"dropoffAddress":{"type":"string","nullable":true},"distanceKm":{"type":"number","example":5.4},"durationMin":{"type":"number","example":14},"preferredMethod":{"type":"string","enum":["CASH","CARD"],"nullable":true,"example":"CASH"}}}}},"required":true},"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"ok":{"type":"boolean"},"trip":{"type":"object","properties":{"id":{"type":"string"},"status":{"type":"string"}}}},"example":{"ok":true,"trip":{"id":"trp_123","status":"ACCEPTED"}}}}}},"400":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Missing city"}}}}}}}},"/trips/{id}/accept":{"post":{"operationId":"tripsAccept","summary":"Aceptar viaje","tags":["Trips"],"description":"El conductor acepta el viaje asignado.","parameters":[{"schema":{"type":"string"},"in":"path","name":"id","required":true}],"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"ok":{"type":"boolean"},"trip":{"type":"object","properties":{"id":{"type":"string"},"status":{"type":"string"}}}},"example":{"ok":true,"trip":{"id":"trp_123","status":"ACCEPTED"}}}}}},"400":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Invalid id"}}}}},"403":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Forbidden"}}}}},"404":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Trip not found"}}}}},"409":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Invalid state for accept"}}}}}}}},"/trips/{id}/arrived":{"post":{"operationId":"tripsArrived","summary":"Arribo del conductor","tags":["Trips"],"description":"El conductor llegï¿½ al punto de recogida.","parameters":[{"schema":{"type":"string"},"in":"path","name":"id","required":true}],"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"ok":{"type":"boolean"},"trip":{"type":"object","properties":{"id":{"type":"string"},"status":{"type":"string"}}}},"example":{"ok":true,"trip":{"id":"trp_123","status":"ARRIVED"}}}}}},"400":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Invalid id"}}}}},"403":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Forbidden"}}}}},"404":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Trip not found"}}}}},"409":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Invalid state for arrived"}}}}}}}},"/trips/{id}/start":{"post":{"operationId":"tripsStart","summary":"Iniciar viaje","tags":["Trips"],"description":"Inicia el viaje; si method=CARD y Stripe estï¿½ configurado, preautoriza.","requestBody":{"content":{"application/json":{"schema":{"type":"object","properties":{"method":{"type":"string","enum":["CASH","CARD"],"default":"CASH"}},"additionalProperties":false,"example":{"method":"CASH"}}}}},"parameters":[{"schema":{"type":"string"},"in":"path","name":"id","required":true}],"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"ok":{"type":"boolean"},"trip":{"type":"object","properties":{"id":{"type":"string"},"status":{"type":"string"}}}},"example":{"ok":true,"trip":{"id":"trp_123","status":"STARTED"}}}}}},"400":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Invalid id"}}}}},"403":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Forbidden"}}}}},"404":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Trip not found"}}}}},"409":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Invalid state for start"}}}}}}}},"/trips/{id}/complete":{"post":{"operationId":"tripsComplete","summary":"Completar viaje","tags":["Trips"],"description":"Completa el viaje y liquida el pago (captura Stripe o marca CASH pagado).","parameters":[{"schema":{"type":"string"},"in":"path","name":"id","required":true}],"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"ok":{"type":"boolean"},"trip":{"type":"object","properties":{"id":{"type":"string"},"status":{"type":"string"}}}},"example":{"ok":true,"trip":{"id":"trp_123","status":"COMPLETED"}}}}}},"400":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Invalid id"}}}}},"403":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Forbidden"}}}}},"404":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Trip not found"}}}}},"409":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Invalid state for complete"}}}}}}}},"/trips/{id}/cancel":{"post":{"operationId":"tripsCancel","summary":"Cancelar viaje (rider)","tags":["Trips"],"description":"El rider cancela el viaje; puede aplicar fee segï¿½n estado y reglas.","requestBody":{"content":{"application/json":{"schema":{"type":"object","properties":{"reason":{"type":"string"}},"additionalProperties":false,"example":{"reason":"CHANGED_MIND"}}}}},"parameters":[{"schema":{"type":"string"},"in":"path","name":"id","required":true}],"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"ok":{"type":"boolean"},"trip":{"type":"object","properties":{"id":{"type":"string"},"status":{"type":"string"}}}},"example":{"ok":true,"trip":{"id":"trp_123","status":"CANCELED"}}}}}},"400":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Invalid id"}}}}},"403":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Forbidden"}}}}},"404":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Trip not found"}}}}},"409":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Invalid state for cancel"}}}}}}}},"/trips/{id}/sse":{"get":{"operationId":"tripsSseById","summary":"Trip live updates (SSE)","tags":["Trips"],"description":"Stream de eventos del viaje en tiempo real para Rider/Driver via Server-Sent Events. EnvÃ­a eventos como INIT/ASSIGNED/ACCEPTED/ARRIVED/STARTED/COMPLETED/CANCELED y LOCATION (lat/lng del driver).","parameters":[{"schema":{"type":"string"},"in":"path","name":"id","required":true}],"responses":{"200":{"description":"text/event-stream","content":{"text/event-stream":{"schema":{"type":"string","example":"event: INIT\ndata: {\"status\":\"ASSIGNED\"}\n\n"}}}}}}},"/trips/{id}/driver-location":{"get":{"operationId":"tripsDriverLocation","summary":"UbicaciÃ³n actual del driver para el viaje","tags":["Trips"],"description":"Devuelve lat/lng y timestamp de la Ãºltima ubicaciï¿½n reportada por el driver asignado al trip.","parameters":[{"schema":{"type":"string"},"in":"path","name":"id","required":true}],"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"tripId":{"type":"string"},"driverId":{"type":"string","nullable":true},"lat":{"type":"number","nullable":true},"lng":{"type":"number","nullable":true},"locationUpdatedAt":{"type":"string","format":"date-time","nullable":true}},"example":{"tripId":"trp_123","driverId":"u_driver","lat":-2.17,"lng":-79.92,"locationUpdatedAt":"2025-01-01T12:00:00.000Z"}}}}},"400":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Invalid id"}}}}},"403":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Forbidden"}}}}},"404":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Trip not found"}}}}}}}},"/admin/trips":{"get":{"operationId":"adminTripsList","tags":["admin"],"parameters":[{"schema":{"type":"integer","minimum":1,"maximum":200,"default":50},"in":"query","name":"limit","required":false},{"schema":{"type":"string"},"in":"query","name":"cursor","required":false}],"security":[{"bearerAuth":[]}],"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"items":{"type":"array","items":{"type":"object","properties":{"id":{"type":"string"},"status":{"type":"string"},"riderId":{"type":"string"},"driverId":{"type":"string"},"requestedAt":{"type":"string","format":"date-time"},"completedAt":{"type":"string","format":"date-time","nullable":true},"costUsd":{"type":"number"},"currency":{"type":"string"}}}},"nextCursor":{"type":"string","nullable":true}}}}}},"401":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Unauthorized"}}}}},"403":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Forbidden"}}}}}}}},"/admin/diagnostics/matching":{"get":{"operationId":"adminDiagnosticsMatching","summary":"Diagnostics matching","tags":["admin"],"description":"Estado de PostGIS y parÃ¡metros de matching (env) + contadores de uso.","responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"postgisAvailable":{"type":"boolean"},"env":{"type":"object","properties":{"MATCH_RADIUS_M":{"type":"integer"},"LOCATION_MAX_AGE_MIN":{"type":"integer"}}},"counters":{"type":"object","additionalProperties":{"type":"integer"}}}}}}},"401":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Unauthorized"}}}}},"403":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Forbidden"}}}}}}}},"/admin/diagnostics/matching/test":{"post":{"operationId":"adminDiagnosticsMatchingTest","summary":"Probar matching (PostGIS/Haversine/Idle)","tags":["admin"],"description":"Intenta encontrar el driver más cercano usando PostGIS si está disponible; de lo contrario cae a Haversine y finalmente idle fallback. Incrementa contadores de métricas según el camino usado.","requestBody":{"content":{"application/json":{"schema":{"type":"object","required":["pickupLat","pickupLng"],"properties":{"pickupLat":{"type":"number","example":-2.17},"pickupLng":{"type":"number","example":-79.92},"radiusM":{"type":"number","default":5000},"maxAgeMin":{"type":"number","default":10}},"additionalProperties":false}}},"required":true},"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"postgisAvailable":{"type":"boolean"},"modeUsed":{"type":"string","enum":["POSTGIS","HAVERSINE","IDLE"]},"driverId":{"type":"string","nullable":true},"meters":{"type":"number","nullable":true},"candidatesChecked":{"type":"number","nullable":true}},"example":{"postgisAvailable":true,"modeUsed":"POSTGIS","driverId":"usr_123","meters":120.3}}}}},"401":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Unauthorized"}}}}},"403":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Forbidden"}}}}}}}},"/admin/metrics":{"get":{"operationId":"adminMetrics","summary":"Prometheus metrics","tags":["admin"],"description":"ExposiciÃ³n de mÃ©tricas en formato Prometheus. Protegido por rol ADMIN.","responses":{"200":{"description":"Default Response"}}}},"/metrics":{"get":{"operationId":"metricsPublic","summary":"Prometheus metrics (public)","tags":["admin"],"description":"Endpoint para scraping por Prometheus. Requiere header x-metrics-token si METRICS_TOKEN estÃ¡ definido o si METRICS_PUBLIC=false.","security":[],"responses":{"200":{"description":"Default Response"}}}},"/admin/tariffs":{"get":{"operationId":"adminTariffsList","summary":"Listar TariffRule","tags":["admin"],"description":"Lista reglas por ciudad.","parameters":[{"schema":{"type":"string"},"in":"query","name":"city","required":false},{"schema":{"type":"boolean"},"in":"query","name":"active","required":false}],"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"items":{"type":"array","items":{"type":"object","properties":{"id":{"type":"string"},"city":{"type":"string"},"active":{"type":"boolean"},"baseFareUsd":{"type":"number","minimum":0,"multipleOf":0.01},"perKmUsd":{"type":"number","minimum":0,"multipleOf":0.01},"perMinUsd":{"type":"number","minimum":0,"multipleOf":0.01},"minFareUsd":{"type":"number","minimum":0,"multipleOf":0.01},"nightMultiplier":{"type":"number"},"weekendMultiplier":{"type":"number"},"surgeMultiplier":{"type":"number"},"nightStartHour":{"type":"integer","nullable":true},"nightEndHour":{"type":"integer","nullable":true},"cancellationGraceSec":{"type":"integer","nullable":true},"cancellationFeeAcceptedUsd":{"type":"number","minimum":0,"multipleOf":0.01},"cancellationFeeArrivedUsd":{"type":"number","minimum":0,"multipleOf":0.01},"validFrom":{"type":"string","format":"date-time","nullable":true},"validTo":{"type":"string","format":"date-time","nullable":true},"notes":{"type":"string","nullable":true},"createdAt":{"type":"string","format":"date-time"},"updatedAt":{"type":"string","format":"date-time"}}}}}}}}},"401":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Unauthorized"}}}}},"403":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Forbidden"}}}}}}},"post":{"operationId":"adminTariffsCreate","summary":"Crear TariffRule","tags":["admin"],"description":"Crea una regla y opcionalmente desactiva reglas activas previas de la misma ciudad.","requestBody":{"content":{"application/json":{"schema":{"type":"object","required":["city","baseFareUsd","perKmUsd","perMinUsd"],"properties":{"city":{"type":"string","minLength":2,"example":"Guayaquil"},"active":{"type":"boolean","default":true},"baseFareUsd":{"type":"number","minimum":0,"multipleOf":0.01},"perKmUsd":{"type":"number","minimum":0,"multipleOf":0.01},"perMinUsd":{"type":"number","minimum":0,"multipleOf":0.01},"minFareUsd":{"type":"number","minimum":0,"multipleOf":0.01},"nightMultiplier":{"type":"number","minimum":0,"default":1},"weekendMultiplier":{"type":"number","minimum":0,"default":1},"surgeMultiplier":{"type":"number","minimum":0,"default":1},"nightStartHour":{"type":"integer","minimum":0,"maximum":23,"nullable":true},"nightEndHour":{"type":"integer","minimum":0,"maximum":23,"nullable":true},"cancellationGraceSec":{"type":"integer","minimum":0,"nullable":true,"example":120},"cancellationFeeAcceptedUsd":{"type":"number","minimum":0,"multipleOf":0.01},"cancellationFeeArrivedUsd":{"type":"number","minimum":0,"multipleOf":0.01},"notes":{"type":"string","nullable":true},"deactivateOld":{"type":"boolean","default":true,"description":"Si true, desactiva reglas activas previas de la misma ciudad"}},"additionalProperties":false,"example":{"city":"Guayaquil","active":true,"baseFareUsd":1.5,"perKmUsd":0.5,"perMinUsd":0.15,"minFareUsd":2,"nightMultiplier":1.2,"weekendMultiplier":1.1,"surgeMultiplier":1,"nightStartHour":22,"nightEndHour":5,"cancellationGraceSec":120,"cancellationFeeAcceptedUsd":1,"cancellationFeeArrivedUsd":2,"notes":"Regla base ciudad","deactivateOld":true}}}},"required":true},"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"id":{"type":"string"},"city":{"type":"string"},"active":{"type":"boolean"},"baseFareUsd":{"type":"number","minimum":0,"multipleOf":0.01},"perKmUsd":{"type":"number","minimum":0,"multipleOf":0.01},"perMinUsd":{"type":"number","minimum":0,"multipleOf":0.01},"minFareUsd":{"type":"number","minimum":0,"multipleOf":0.01},"nightMultiplier":{"type":"number"},"weekendMultiplier":{"type":"number"},"surgeMultiplier":{"type":"number"},"nightStartHour":{"type":"integer","nullable":true},"nightEndHour":{"type":"integer","nullable":true},"cancellationGraceSec":{"type":"integer","nullable":true},"cancellationFeeAcceptedUsd":{"type":"number","minimum":0,"multipleOf":0.01},"cancellationFeeArrivedUsd":{"type":"number","minimum":0,"multipleOf":0.01},"validFrom":{"type":"string","format":"date-time","nullable":true},"validTo":{"type":"string","format":"date-time","nullable":true},"notes":{"type":"string","nullable":true},"createdAt":{"type":"string","format":"date-time"},"updatedAt":{"type":"string","format":"date-time"}}}}}},"401":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Unauthorized"}}}}},"403":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Forbidden"}}}}}}}},"/admin/tariffs/{id}":{"patch":{"operationId":"adminTariffsUpdateById","summary":"Actualizar TariffRule","tags":["admin"],"description":"Actualiza campos de una regla por id.","requestBody":{"content":{"application/json":{"schema":{"type":"object","properties":{"city":{"type":"string","minLength":2,"example":"Guayaquil"},"active":{"type":"boolean","default":true},"baseFareUsd":{"type":"number","minimum":0,"multipleOf":0.01},"perKmUsd":{"type":"number","minimum":0,"multipleOf":0.01},"perMinUsd":{"type":"number","minimum":0,"multipleOf":0.01},"minFareUsd":{"type":"number","minimum":0,"multipleOf":0.01},"nightMultiplier":{"type":"number","minimum":0,"default":1},"weekendMultiplier":{"type":"number","minimum":0,"default":1},"surgeMultiplier":{"type":"number","minimum":0,"default":1},"nightStartHour":{"type":"integer","minimum":0,"maximum":23,"nullable":true},"nightEndHour":{"type":"integer","minimum":0,"maximum":23,"nullable":true},"cancellationGraceSec":{"type":"integer","minimum":0,"nullable":true,"example":120},"cancellationFeeAcceptedUsd":{"type":"number","minimum":0,"multipleOf":0.01},"cancellationFeeArrivedUsd":{"type":"number","minimum":0,"multipleOf":0.01},"notes":{"type":"string","nullable":true},"deactivateOld":{"type":"boolean","default":true,"description":"Si true, desactiva reglas activas previas de la misma ciudad"}},"additionalProperties":false}}}},"parameters":[{"schema":{"type":"string"},"in":"path","name":"id","required":true}],"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"id":{"type":"string"},"city":{"type":"string"},"active":{"type":"boolean"},"baseFareUsd":{"type":"number","minimum":0,"multipleOf":0.01},"perKmUsd":{"type":"number","minimum":0,"multipleOf":0.01},"perMinUsd":{"type":"number","minimum":0,"multipleOf":0.01},"minFareUsd":{"type":"number","minimum":0,"multipleOf":0.01},"nightMultiplier":{"type":"number"},"weekendMultiplier":{"type":"number"},"surgeMultiplier":{"type":"number"},"nightStartHour":{"type":"integer","nullable":true},"nightEndHour":{"type":"integer","nullable":true},"cancellationGraceSec":{"type":"integer","nullable":true},"cancellationFeeAcceptedUsd":{"type":"number","minimum":0,"multipleOf":0.01},"cancellationFeeArrivedUsd":{"type":"number","minimum":0,"multipleOf":0.01},"validFrom":{"type":"string","format":"date-time","nullable":true},"validTo":{"type":"string","format":"date-time","nullable":true},"notes":{"type":"string","nullable":true},"createdAt":{"type":"string","format":"date-time"},"updatedAt":{"type":"string","format":"date-time"}}}}}},"401":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Unauthorized"}}}}},"403":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Forbidden"}}}}},"404":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}}}}}}}}},"/users/me/push-token":{"post":{"operationId":"usersRegisterPushToken","summary":"Registrar FCM token","tags":["users"],"description":"Registra o actualiza el FCM token del usuario logueado.","requestBody":{"content":{"application/json":{"schema":{"type":"object","required":["fcmToken"],"properties":{"fcmToken":{"type":"string","minLength":10,"example":"d5x...:APA91bH..."}},"additionalProperties":false,"example":{"fcmToken":"d5x...:APA91bHExampleToken"}}}},"required":true},"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"ok":{"type":"boolean"}},"example":{"ok":true}}}}},"401":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Unauthorized"}}}}}}},"delete":{"operationId":"usersDeletePushToken","summary":"Eliminar FCM token","tags":["users"],"description":"Borra el FCM token asociado al usuario (logout de push notifications).","responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"ok":{"type":"boolean"}},"example":{"ok":true}}}}},"401":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Unauthorized"}}}}}}}},"/rider/my-trips":{"get":{"operationId":"riderMyTrips","summary":"Mis viajes (rider)","tags":["rider"],"description":"Lista los últimos viajes del rider autenticado.","parameters":[{"schema":{"type":"integer","minimum":1,"maximum":100,"default":20},"in":"query","name":"limit","required":false},{"schema":{"type":"string","nullable":true},"in":"query","name":"cursor","required":false}],"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"items":{"type":"array","items":{"type":"object","properties":{"id":{"type":"string"},"status":{"type":"string","enum":["REQUESTED","ASSIGNED","ACCEPTED","ARRIVED","STARTED","COMPLETED","CANCELED"]},"pickupLat":{"type":"number"},"pickupLng":{"type":"number"},"dropoffLat":{"type":"number"},"dropoffLng":{"type":"number"},"requestedAt":{"type":"string","format":"date-time"},"completedAt":{"type":"string","format":"date-time","nullable":true},"costUsd":{"type":"number","nullable":true},"currency":{"type":"string","nullable":true},"preferredMethod":{"type":"string","enum":["CASH","CARD"],"nullable":true}}}},"nextCursor":{"type":"string","nullable":true}},"example":{"items":[{"id":"trp_123","status":"COMPLETED","pickupLat":-2.17,"pickupLng":-79.92,"dropoffLat":-2.19,"dropoffLng":-79.89,"requestedAt":"2025-01-01T12:00:00.000Z","completedAt":"2025-01-01T12:30:00.000Z","costUsd":5.5,"currency":"USD","preferredMethod":"CASH"}],"nextCursor":"eyJpZCI6InRycF8xMjMiLCJyZXF1ZXN0ZWRBdCI6IjIwMjUtMDEtMDFUMTI6MzA6MDAuMDAwWiJ9"}}}}},"401":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Unauthorized"}}}}},"403":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Forbidden"}}}}}}}},"/payments":{"get":{"operationId":"paymentsList","summary":"Listar pagos (ADMIN)","tags":["payments"],"description":"Lista pagos con filtros opcionales y paginacion. Si format=csv, devuelve text/csv.","parameters":[{"schema":{"type":"string"},"in":"query","name":"userId","required":false},{"schema":{"type":"string","enum":["PENDING","AUTHORIZED","PAID","FAILED","REFUNDED"]},"in":"query","name":"status","required":false},{"schema":{"type":"string"},"in":"query","name":"city","required":false},{"schema":{"type":"string","format":"date-time"},"in":"query","name":"from","required":false},{"schema":{"type":"string","format":"date-time"},"in":"query","name":"to","required":false},{"schema":{"type":"integer","minimum":1,"maximum":200,"default":50},"in":"query","name":"limit","required":false},{"schema":{"type":"string"},"in":"query","name":"cursor","required":false},{"schema":{"type":"string","enum":["json","csv"],"default":"json"},"in":"query","name":"format","required":false}],"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"items":{"type":"array","items":{"type":"object","properties":{"id":{"type":"string"},"tripId":{"type":"string"},"amountUsd":{"type":"number"},"status":{"type":"string","enum":["PENDING","AUTHORIZED","PAID","FAILED","REFUNDED"]},"method":{"type":"string"},"provider":{"type":"string","nullable":true},"externalId":{"type":"string","nullable":true},"createdAt":{"type":"string","format":"date-time"},"updatedAt":{"type":"string","format":"date-time"},"isAuthorized":{"type":"boolean"},"isPaid":{"type":"boolean"},"isFailed":{"type":"boolean"},"providerDisplay":{"type":"string"},"capturable":{"type":"boolean"}},"example":{"id":"pay_123","tripId":"trp_123","amountUsd":7.8,"status":"PAID","method":"CASH","provider":null,"externalId":null,"isAuthorized":false,"isPaid":true,"isFailed":false,"providerDisplay":"Cash","capturable":false,"createdAt":"2025-01-01T12:20:00.000Z","updatedAt":"2025-01-01T12:20:00.000Z"}}},"nextCursor":{"type":"string","nullable":true}},"example":{"items":[{"id":"pay_123","tripId":"trp_123","amountUsd":7.8,"status":"PAID","method":"CASH","provider":null,"externalId":null,"isAuthorized":false,"isPaid":true,"isFailed":false,"providerDisplay":"Cash","capturable":false,"createdAt":"2025-01-01T12:20:00.000Z","updatedAt":"2025-01-01T12:20:00.000Z"}],"nextCursor":null}}},"text/csv":{"schema":{"type":"string","example":"id,tripId,amountUsd,status,method,provider,externalId,createdAt,updatedAt,isAuthorized,isPaid,isFailed,providerDisplay,capturable\n\"pay_123\",\"trp_123\",7.8,\"PAID\",\"CASH\",\"\",\"\",\"2025-01-01T12:20:00.000Z\",\"2025-01-01T12:20:00.000Z\",false,true,false,\"Cash\",false\n"}}}}}}},"/admin/payments/report":{"get":{"operationId":"adminPaymentsReport","summary":"Reporte de pagos (ADMIN)","tags":["payments"],"description":"Agregados de pagos por fecha/ciudad/estado/m�todo. Si format=csv, devuelve text/csv.","parameters":[{"schema":{"type":"string"},"in":"query","name":"city","required":false},{"schema":{"type":"string","format":"date-time"},"in":"query","name":"from","required":false},{"schema":{"type":"string","format":"date-time"},"in":"query","name":"to","required":false},{"schema":{"type":"string","enum":["day","city","status","city_day","method"],"default":"day"},"in":"query","name":"groupBy","required":false},{"schema":{"type":"string","enum":["json","csv"],"default":"json"},"in":"query","name":"format","required":false}],"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"items":{"type":"array","items":{"type":"object","additionalProperties":true}},"totals":{"type":"object","properties":{"count":{"type":"integer"},"amountUsd":{"type":"number"}}}},"example":{"items":[{"day":"2025-01-01","city":"GYE","status":"PAID","count":12,"amountUsd":45.3}],"totals":{"count":12,"amountUsd":45.3}}}},"text/csv":{"schema":{"type":"string","example":"day,city,status,count,amountUsd\n2025-01-01,GYE,PAID,12,45.30\nTOTAL,,,12,45.30\n"}}}}}}},"/admin/payments/top-drivers":{"get":{"operationId":"adminPaymentsTopDrivers","summary":"Top drivers por ingresos (ADMIN)","tags":["payments"],"description":"Ingresos por driver con pagos PAID. Filtra por fecha/ciudad. CSV disponible.","parameters":[{"schema":{"type":"string"},"in":"query","name":"city","required":false},{"schema":{"type":"string","format":"date-time"},"in":"query","name":"from","required":false},{"schema":{"type":"string","format":"date-time"},"in":"query","name":"to","required":false},{"schema":{"type":"integer","minimum":1,"maximum":200,"default":20},"in":"query","name":"limit","required":false},{"schema":{"type":"string","enum":["json","csv"],"default":"json"},"in":"query","name":"format","required":false}],"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"items":{"type":"array","items":{"type":"object","properties":{"driverId":{"type":"string"},"email":{"type":"string"},"fullName":{"type":"string"},"trips":{"type":"integer"},"amountUsd":{"type":"number"}}}},"totals":{"type":"object","properties":{"trips":{"type":"integer"},"amountUsd":{"type":"number"}}}},"example":{"items":[{"driverId":"usr_drv_1","email":"driver@taxi.local","fullName":"John Doe","trips":5,"amountUsd":42.3}],"totals":{"trips":5,"amountUsd":42.3}}}}}}}}},"/admin/payments/top-riders":{"get":{"operationId":"adminPaymentsTopRiders","summary":"Top riders por gasto (ADMIN)","tags":["payments"],"description":"Gasto por rider con pagos PAID. Filtra por fecha/ciudad. CSV disponible.","parameters":[{"schema":{"type":"string"},"in":"query","name":"city","required":false},{"schema":{"type":"string","format":"date-time"},"in":"query","name":"from","required":false},{"schema":{"type":"string","format":"date-time"},"in":"query","name":"to","required":false},{"schema":{"type":"integer","minimum":1,"maximum":200,"default":20},"in":"query","name":"limit","required":false},{"schema":{"type":"string","enum":["json","csv"],"default":"json"},"in":"query","name":"format","required":false}],"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"items":{"type":"array","items":{"type":"object","properties":{"riderId":{"type":"string"},"email":{"type":"string"},"fullName":{"type":"string"},"trips":{"type":"integer"},"amountUsd":{"type":"number"}}}},"totals":{"type":"object","properties":{"trips":{"type":"integer"},"amountUsd":{"type":"number"}}}},"example":{"items":[{"riderId":"usr_rdr_1","email":"rider@taxi.local","fullName":"Jane Roe","trips":6,"amountUsd":55.8}],"totals":{"trips":6,"amountUsd":55.8}}}}}}}}},"/admin/payments/summary-status":{"get":{"operationId":"adminPaymentsSummaryStatus","summary":"Resumen por estado de pago (ADMIN)","tags":["payments"],"description":"Conteo e importe por estado (PENDING/AUTHORIZED/PAID/FAILED/REFUNDED). CSV disponible.","parameters":[{"schema":{"type":"string"},"in":"query","name":"city","required":false},{"schema":{"type":"string","format":"date-time"},"in":"query","name":"from","required":false},{"schema":{"type":"string","format":"date-time"},"in":"query","name":"to","required":false},{"schema":{"type":"string","enum":["json","csv"],"default":"json"},"in":"query","name":"format","required":false}],"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"items":{"type":"array","items":{"type":"object","properties":{"status":{"type":"string"},"count":{"type":"integer"},"amountUsd":{"type":"number"}}}},"totals":{"type":"object","properties":{"count":{"type":"integer"},"amountUsd":{"type":"number"}}}},"example":{"items":[{"status":"PAID","count":10,"amountUsd":80.1},{"status":"FAILED","count":1,"amountUsd":7.5}],"totals":{"count":11,"amountUsd":87.6}}}}}}}}},"/payments/{tripId}/capture":{"post":{"operationId":"paymentsCaptureByTrip","summary":"Capturar pago autorizado (ADMIN)","tags":["payments"],"description":"Captura un PaymentIntent autorizado de Stripe para el trip.","parameters":[{"schema":{"type":"string","example":"trp_123"},"in":"path","name":"tripId","required":true}],"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"ok":{"type":"boolean"}},"example":{"ok":true}}}}},"400":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"No hay autorizacion Stripe capturable"}}}}},"404":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Payment no encontrado"}}}}}}}},"/payments/{tripId}/refund":{"post":{"operationId":"paymentsRefundByTrip","summary":"Refund/cancel (ADMIN)","tags":["payments"],"description":"Reembolsa un Payment capturado (Stripe) o cancela autorizacion. Para otros metodos, marca REFUNDED y registra auditoria.","requestBody":{"content":{"application/json":{"schema":{"type":"object","properties":{"amountUsd":{"type":"number"},"reason":{"type":"string"}},"additionalProperties":false,"example":{"amountUsd":2.5,"reason":"customer_request"}}}}},"parameters":[{"schema":{"type":"string","example":"trp_123"},"in":"path","name":"tripId","required":true}],"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"ok":{"type":"boolean"}},"example":{"ok":true}}}}},"400":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"No hay autorizacion Stripe capturable"}}}}},"404":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Payment no encontrado"}}}}}}}},"/payments/{tripId}":{"get":{"operationId":"paymentsGetByTrip","summary":"Obtener pago por tripId","tags":["payments"],"description":"Devuelve el registro de Payment asociado a un Trip. Requiere JWT y ser due�o del viaje o ADMIN.","parameters":[{"schema":{"type":"string","example":"trp_123"},"in":"path","name":"tripId","required":true}],"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"id":{"type":"string"},"tripId":{"type":"string"},"amountUsd":{"type":"number"},"status":{"type":"string","enum":["PENDING","AUTHORIZED","PAID","FAILED","REFUNDED"]},"method":{"type":"string"},"provider":{"type":"string","nullable":true},"externalId":{"type":"string","nullable":true},"createdAt":{"type":"string","format":"date-time"},"updatedAt":{"type":"string","format":"date-time"},"isAuthorized":{"type":"boolean"},"isPaid":{"type":"boolean"},"isFailed":{"type":"boolean"},"providerDisplay":{"type":"string"},"capturable":{"type":"boolean"}},"example":{"id":"pay_123","tripId":"trp_123","amountUsd":7.8,"status":"PAID","method":"CASH","provider":null,"externalId":null,"isAuthorized":false,"isPaid":true,"isFailed":false,"providerDisplay":"Cash","capturable":false,"createdAt":"2025-01-01T12:20:00.000Z","updatedAt":"2025-01-01T12:20:00.000Z"}}}}},"403":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Forbidden"}}}}},"404":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Payment no encontrado"}}}}}}}},"/payments/{tripId}/receipt":{"get":{"operationId":"paymentsReceiptByTrip","summary":"Obtener recibo","tags":["payments"],"description":"Recibo simple del pago asociado al viaje. type=TRIP o CANCELLATION_FEE.","parameters":[{"schema":{"type":"string","example":"trp_123"},"in":"path","name":"tripId","required":true}],"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"tripId":{"type":"string"},"amountUsd":{"type":"number"},"currency":{"type":"string"},"method":{"type":"string"},"status":{"type":"string"},"provider":{"type":"string","nullable":true},"type":{"type":"string","enum":["TRIP","CANCELLATION_FEE"]},"paidAt":{"type":"string","format":"date-time","nullable":true}},"example":{"tripId":"trp_123","amountUsd":2,"currency":"USD","method":"CARD","status":"PAID","provider":"Stripe","type":"CANCELLATION_FEE","paidAt":"2025-01-01T12:00:00.000Z"}}}}},"404":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}}}}}}}}},"/payments/{tripId}/refunds":{"get":{"operationId":"paymentsRefundsByTrip","summary":"Refunds por tripId","tags":["payments"],"description":"Lista auditorias de reembolso/cancelación del pago de un trip. Requiere JWT y ser due�o del viaje o ADMIN.","parameters":[{"schema":{"type":"string","example":"trp_123"},"in":"path","name":"tripId","required":true}],"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"items":{"type":"array","items":{"type":"object","properties":{"id":{"type":"string"},"paymentId":{"type":"string"},"tripId":{"type":"string"},"amountUsd":{"type":"number"},"reason":{"type":"string","nullable":true},"provider":{"type":"string","nullable":true},"externalId":{"type":"string","nullable":true},"createdAt":{"type":"string","format":"date-time"}}}}},"example":{"items":[{"id":"re_1","paymentId":"pay_1","tripId":"trp_1","amountUsd":1.5,"reason":"admin_refund","provider":"Stripe","externalId":"re_123","createdAt":"2025-01-01T12:00:00.000Z"}]}}}}},"403":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Forbidden"}}}}},"404":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}},"example":{"error":"Trip no encontrado"}}}}}}}},"/admin/refunds":{"get":{"operationId":"adminRefundsList","summary":"Listar refunds (ADMIN)","tags":["payments"],"description":"Lista auditorias de reembolso/cancelación con filtros y CSV. Si format=csv, devuelve text/csv.","parameters":[{"schema":{"type":"string"},"in":"query","name":"userId","required":false},{"schema":{"type":"string"},"in":"query","name":"city","required":false},{"schema":{"type":"string","format":"date-time"},"in":"query","name":"from","required":false},{"schema":{"type":"string","format":"date-time"},"in":"query","name":"to","required":false},{"schema":{"type":"integer","minimum":1,"maximum":200,"default":50},"in":"query","name":"limit","required":false},{"schema":{"type":"string"},"in":"query","name":"cursor","required":false},{"schema":{"type":"string","enum":["json","csv"],"default":"json"},"in":"query","name":"format","required":false}],"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"items":{"type":"array","items":{"type":"object","properties":{"id":{"type":"string"},"paymentId":{"type":"string"},"tripId":{"type":"string"},"amountUsd":{"type":"number"},"reason":{"type":"string","nullable":true},"provider":{"type":"string","nullable":true},"externalId":{"type":"string","nullable":true},"createdAt":{"type":"string","format":"date-time"}}}},"nextCursor":{"type":"string","nullable":true}}}},"text/csv":{"schema":{"type":"string","example":"id,paymentId,tripId,amountUsd,reason,provider,externalId,createdAt\n\"re_1\",\"pay_1\",\"trp_1\",1.5,\"admin_refund\",\"Stripe\",\"re_123\",\"2025-01-01T12:00:00.000Z\"\n"}}}}}}},"/webhooks/stripe":{"post":{"operationId":"webhooksStripe","summary":"Stripe webhook","tags":["payments"],"security":[],"responses":{"200":{"description":"Default Response"}}}},"/payments/setup-intent":{"post":{"operationId":"paymentsCreateSetupIntent","summary":"Crear SetupIntent","tags":["payments"],"description":"Rider crea un SetupIntent para guardar una tarjeta. Devuelve client_secret.","responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"clientSecret":{"type":"string"}}}}}},"400":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}}}}}},"404":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}}}}}}}}},"/payments/set-default":{"post":{"operationId":"paymentsSetDefaultMethod","summary":"Definir PM por defecto","tags":["payments"],"description":"Guarda el paymentMethod como predeterminado en Stripe y DB.","requestBody":{"content":{"application/json":{"schema":{"type":"object","required":["paymentMethodId"],"properties":{"paymentMethodId":{"type":"string","example":"pm_123"}}}}},"required":true},"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"ok":{"type":"boolean"}}}}}},"400":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}}}}}}}}}},"servers":[{"url":"http://localhost:8080"}],"security":[{"bearerAuth":[]}]}