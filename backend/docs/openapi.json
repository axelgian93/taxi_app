{"openapi":"3.1.0","info":{"title":"Taxi API","description":"API de Taxi","version":"1.0.0"},"components":{"securitySchemes":{"bearerAuth":{"type":"http","scheme":"bearer"}},"schemas":{}},"paths":{"/healthz":{"get":{"operationId":"healthz","security":[],"responses":{"200":{"description":"Default Response"}}}},"/auth/register":{"post":{"operationId":"authRegister","tags":["auth"],"requestBody":{"content":{"application/json":{"schema":{"type":"object","required":["email","password","firstName","lastName","role"],"properties":{"email":{"type":"string","format":"email","example":"driver@taxi.local"},"password":{"type":"string","minLength":6,"example":"123456"},"firstName":{"type":"string","example":"John"},"lastName":{"type":"string","example":"Doe"},"role":{"type":"string","enum":["ADMIN","DRIVER","RIDER"],"example":"DRIVER"}},"additionalProperties":false}}},"required":true},"security":[],"responses":{"201":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"token":{"type":"string"},"user":{"type":"object","properties":{"id":{"type":"string"},"email":{"type":"string"},"role":{"type":"string","enum":["ADMIN","DRIVER","RIDER"]}}}}}}}},"400":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}}}}}}}}},"/auth/login":{"post":{"operationId":"authLogin","tags":["auth"],"requestBody":{"content":{"application/json":{"schema":{"type":"object","required":["email","password"],"properties":{"email":{"type":"string","format":"email","example":"driver@taxi.local"},"password":{"type":"string","minLength":6,"example":"123456"}},"additionalProperties":false}}},"required":true},"security":[],"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"token":{"type":"string"},"user":{"type":"object","properties":{"id":{"type":"string"},"email":{"type":"string"},"role":{"type":"string","enum":["ADMIN","DRIVER","RIDER"]}}}}}}}},"401":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}}}}}}}}},"/auth/me":{"get":{"operationId":"authMe","tags":["auth"],"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"user":{"type":"object","properties":{"id":{"type":"string"},"email":{"type":"string"},"role":{"type":"string","enum":["ADMIN","DRIVER","RIDER"]},"firstName":{"type":"string"},"lastName":{"type":"string"}}}}}}}},"401":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}}}}}}}}},"/drivers/status":{"post":{"operationId":"driverUpdateStatus","summary":"Actualizar estado del driver","tags":["drivers"],"description":"Driver reporta su estado (IDLE/ON_TRIP/etc.). Requiere JWT.","requestBody":{"content":{"application/json":{"schema":{"type":"object","properties":{"lat":{"type":"number","example":-2.17},"lng":{"type":"number","example":-79.92},"status":{"type":"string","enum":["IDLE","ASSIGNED","ARRIVED","ON_TRIP","OFFLINE"],"example":"IDLE"}},"additionalProperties":false}}}},"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"ok":{"type":"boolean"}}}}}}}}},"/drivers/location":{"post":{"operationId":"driverUpdateLocation","summary":"Actualizar estado del driver","tags":["drivers"],"description":"Driver reporta su estado (IDLE/ON_TRIP/etc.). Requiere JWT.","requestBody":{"content":{"application/json":{"schema":{"type":"object","properties":{"lat":{"type":"number","example":-2.17},"lng":{"type":"number","example":-79.92},"status":{"type":"string","enum":["IDLE","ASSIGNED","ARRIVED","ON_TRIP","OFFLINE"],"example":"IDLE"}},"additionalProperties":false}}}},"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"ok":{"type":"boolean"}}}}}}}}},"/trips/request":{"post":{"operationId":"tripsRequest","summary":"Solicitar viaje","tags":["Trips"],"description":"Crea un viaje y asigna el conductor disponible más cercano.","requestBody":{"content":{"application/json":{"schema":{"type":"object","required":["city","pickupLat","pickupLng","dropoffLat","dropoffLng","distanceKm","durationMin"],"properties":{"city":{"type":"string","example":"Guayaquil"},"pickupLat":{"type":"number","example":-2.17},"pickupLng":{"type":"number","example":-79.92},"dropoffLat":{"type":"number","example":-2.19},"dropoffLng":{"type":"number","example":-79.89},"pickupAddress":{"type":"string","nullable":true},"dropoffAddress":{"type":"string","nullable":true},"distanceKm":{"type":"number","example":5.4},"durationMin":{"type":"number","example":14}}}}},"required":true},"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"ok":{"type":"boolean"},"trip":{"type":"object","properties":{"id":{"type":"string"},"status":{"type":"string","enum":["ASSIGNED","ACCEPTED","ARRIVED","ONGOING","COMPLETED","CANCELED"]}}}}}}}},"400":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}}}}}}}}},"/trips/{id}/accept":{"post":{"operationId":"tripsAccept","tags":["Trips"],"parameters":[{"schema":{"type":"string"},"in":"path","name":"id","required":true}],"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"ok":{"type":"boolean"},"trip":{"type":"object","properties":{"id":{"type":"string"},"status":{"type":"string","enum":["ASSIGNED","ACCEPTED","ARRIVED","ONGOING","COMPLETED","CANCELED"]}}}}}}}},"400":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}}}}}},"403":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}}}}}},"404":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}}}}}}}}},"/trips/{id}/arrived":{"post":{"operationId":"tripsArrived","tags":["Trips"],"parameters":[{"schema":{"type":"string"},"in":"path","name":"id","required":true}],"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"ok":{"type":"boolean"},"trip":{"type":"object","properties":{"id":{"type":"string"},"status":{"type":"string","enum":["ASSIGNED","ACCEPTED","ARRIVED","ONGOING","COMPLETED","CANCELED"]}}}}}}}},"400":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}}}}}},"403":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}}}}}},"404":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}}}}}}}}},"/trips/{id}/start":{"post":{"operationId":"tripsStart","tags":["Trips"],"parameters":[{"schema":{"type":"string"},"in":"path","name":"id","required":true}],"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"ok":{"type":"boolean"},"trip":{"type":"object","properties":{"id":{"type":"string"},"status":{"type":"string","enum":["ASSIGNED","ACCEPTED","ARRIVED","ONGOING","COMPLETED","CANCELED"]}}}}}}}},"400":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}}}}}},"403":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}}}}}},"404":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}}}}}}}}},"/trips/{id}/complete":{"post":{"operationId":"tripsComplete","tags":["Trips"],"parameters":[{"schema":{"type":"string"},"in":"path","name":"id","required":true}],"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"ok":{"type":"boolean"},"trip":{"type":"object","properties":{"id":{"type":"string"},"status":{"type":"string","enum":["ASSIGNED","ACCEPTED","ARRIVED","ONGOING","COMPLETED","CANCELED"]}}}}}}}},"400":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}}}}}},"403":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}}}}}},"404":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}}}}}}}}},"/trips/{id}/cancel":{"post":{"operationId":"tripsCancel","tags":["Trips"],"requestBody":{"content":{"application/json":{"schema":{"type":"object","properties":{"reason":{"type":"string"}}}}}},"parameters":[{"schema":{"type":"string"},"in":"path","name":"id","required":true}],"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"ok":{"type":"boolean"},"trip":{"type":"object","properties":{"id":{"type":"string"},"status":{"type":"string","enum":["ASSIGNED","ACCEPTED","ARRIVED","ONGOING","COMPLETED","CANCELED"]}}}}}}}},"400":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}}}}}},"403":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}}}}}},"404":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}}}}}}}}},"/trips/{id}/sse":{"get":{"operationId":"tripsSseById","summary":"Trip live updates (SSE)","tags":["Trips"],"description":"Stream de eventos del viaje en tiempo real para Rider/Driver via Server-Sent Events. Envía eventos como INIT/ASSIGNED/ACCEPTED/ARRIVED/STARTED/COMPLETED/CANCELED.","parameters":[{"schema":{"type":"string"},"in":"path","name":"id","required":true}],"responses":{"200":{"description":"text/event-stream","content":{"text/event-stream":{"schema":{"type":"string","example":"event: INIT\ndata: {\"status\":\"ASSIGNED\"}\n\n"}}}}}}},"/admin/trips":{"get":{"operationId":"adminTripsList","tags":["admin"],"parameters":[{"schema":{"type":"integer","minimum":1,"maximum":200,"default":50},"in":"query","name":"limit","required":false},{"schema":{"type":"string"},"in":"query","name":"cursor","required":false}],"security":[{"bearerAuth":[]}],"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"items":{"type":"array","items":{"type":"object","properties":{"id":{"type":"string"},"status":{"type":"string"},"riderId":{"type":"string"},"driverId":{"type":"string"},"requestedAt":{"type":"string","format":"date-time"},"completedAt":{"type":"string","format":"date-time","nullable":true},"costUsd":{"type":"number"},"currency":{"type":"string"}}}},"nextCursor":{"type":"string","nullable":true}}}}}}}}},"/admin/diagnostics/matching":{"get":{"operationId":"adminDiagnosticsMatching","summary":"Diagnostics matching","tags":["admin"],"description":"Estado de PostGIS y parÃ¡metros de matching (env) + contadores de uso.","responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"postgisAvailable":{"type":"boolean"},"env":{"type":"object","properties":{"MATCH_RADIUS_M":{"type":"integer"},"LOCATION_MAX_AGE_MIN":{"type":"integer"}}},"counters":{"type":"object","additionalProperties":{"type":"integer"}}}}}}}}}},"/admin/metrics":{"get":{"operationId":"adminMetrics","summary":"Prometheus metrics","tags":["admin"],"description":"Exposición de métricas en formato Prometheus. Protegido por rol ADMIN.","responses":{"200":{"description":"Default Response"}}}},"/metrics":{"get":{"operationId":"metricsPublic","summary":"Prometheus metrics (public)","tags":["admin"],"description":"Endpoint para scraping por Prometheus. Requiere header x-metrics-token si METRICS_TOKEN está definido o si METRICS_PUBLIC=false.","security":[],"responses":{"200":{"description":"Default Response"}}}},"/admin/tariffs":{"get":{"operationId":"adminTariffsList","summary":"Listar TariffRule","tags":["admin"],"description":"Lista reglas por ciudad.","parameters":[{"schema":{"type":"string"},"in":"query","name":"city","required":false},{"schema":{"type":"boolean"},"in":"query","name":"active","required":false}],"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"items":{"type":"array","items":{"type":"object","properties":{"id":{"type":"string"},"city":{"type":"string"},"active":{"type":"boolean"},"baseFareUsd":{"type":"number","minimum":0,"multipleOf":0.01},"perKmUsd":{"type":"number","minimum":0,"multipleOf":0.01},"perMinUsd":{"type":"number","minimum":0,"multipleOf":0.01},"minFareUsd":{"type":"number","minimum":0,"multipleOf":0.01},"nightMultiplier":{"type":"number"},"weekendMultiplier":{"type":"number"},"surgeMultiplier":{"type":"number"},"nightStartHour":{"type":"integer","nullable":true},"nightEndHour":{"type":"integer","nullable":true},"cancellationGraceSec":{"type":"integer","nullable":true},"cancellationFeeAcceptedUsd":{"type":"number","minimum":0,"multipleOf":0.01},"cancellationFeeArrivedUsd":{"type":"number","minimum":0,"multipleOf":0.01},"validFrom":{"type":"string","format":"date-time","nullable":true},"validTo":{"type":"string","format":"date-time","nullable":true},"notes":{"type":"string","nullable":true},"createdAt":{"type":"string","format":"date-time"},"updatedAt":{"type":"string","format":"date-time"}}}}}}}}}}},"post":{"operationId":"adminTariffsCreate","summary":"Crear TariffRule","tags":["admin"],"description":"Crea una regla y opcionalmente desactiva reglas activas previas de la misma ciudad.","requestBody":{"content":{"application/json":{"schema":{"type":"object","required":["city","baseFareUsd","perKmUsd","perMinUsd"],"properties":{"city":{"type":"string","minLength":2,"example":"Guayaquil"},"active":{"type":"boolean","default":true},"baseFareUsd":{"type":"number","minimum":0,"multipleOf":0.01},"perKmUsd":{"type":"number","minimum":0,"multipleOf":0.01},"perMinUsd":{"type":"number","minimum":0,"multipleOf":0.01},"minFareUsd":{"type":"number","minimum":0,"multipleOf":0.01},"nightMultiplier":{"type":"number","minimum":0,"default":1},"weekendMultiplier":{"type":"number","minimum":0,"default":1},"surgeMultiplier":{"type":"number","minimum":0,"default":1},"nightStartHour":{"type":"integer","minimum":0,"maximum":23,"nullable":true},"nightEndHour":{"type":"integer","minimum":0,"maximum":23,"nullable":true},"cancellationGraceSec":{"type":"integer","minimum":0,"nullable":true,"example":120},"cancellationFeeAcceptedUsd":{"type":"number","minimum":0,"multipleOf":0.01},"cancellationFeeArrivedUsd":{"type":"number","minimum":0,"multipleOf":0.01},"notes":{"type":"string","nullable":true},"deactivateOld":{"type":"boolean","default":true,"description":"Si true, desactiva reglas activas previas de la misma ciudad"}},"additionalProperties":false,"example":{"city":"Guayaquil","active":true,"baseFareUsd":1.5,"perKmUsd":0.5,"perMinUsd":0.15,"minFareUsd":2,"nightMultiplier":1.2,"weekendMultiplier":1.1,"surgeMultiplier":1,"nightStartHour":22,"nightEndHour":5,"cancellationGraceSec":120,"cancellationFeeAcceptedUsd":1,"cancellationFeeArrivedUsd":2,"notes":"Regla base ciudad","deactivateOld":true}}}},"required":true},"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"id":{"type":"string"},"city":{"type":"string"},"active":{"type":"boolean"},"baseFareUsd":{"type":"number","minimum":0,"multipleOf":0.01},"perKmUsd":{"type":"number","minimum":0,"multipleOf":0.01},"perMinUsd":{"type":"number","minimum":0,"multipleOf":0.01},"minFareUsd":{"type":"number","minimum":0,"multipleOf":0.01},"nightMultiplier":{"type":"number"},"weekendMultiplier":{"type":"number"},"surgeMultiplier":{"type":"number"},"nightStartHour":{"type":"integer","nullable":true},"nightEndHour":{"type":"integer","nullable":true},"cancellationGraceSec":{"type":"integer","nullable":true},"cancellationFeeAcceptedUsd":{"type":"number","minimum":0,"multipleOf":0.01},"cancellationFeeArrivedUsd":{"type":"number","minimum":0,"multipleOf":0.01},"validFrom":{"type":"string","format":"date-time","nullable":true},"validTo":{"type":"string","format":"date-time","nullable":true},"notes":{"type":"string","nullable":true},"createdAt":{"type":"string","format":"date-time"},"updatedAt":{"type":"string","format":"date-time"}}}}}}}}},"/admin/tariffs/{id}":{"patch":{"operationId":"adminTariffsUpdateById","summary":"Actualizar TariffRule","tags":["admin"],"description":"Actualiza campos de una regla por id.","requestBody":{"content":{"application/json":{"schema":{"type":"object","properties":{"city":{"type":"string","minLength":2,"example":"Guayaquil"},"active":{"type":"boolean","default":true},"baseFareUsd":{"type":"number","minimum":0,"multipleOf":0.01},"perKmUsd":{"type":"number","minimum":0,"multipleOf":0.01},"perMinUsd":{"type":"number","minimum":0,"multipleOf":0.01},"minFareUsd":{"type":"number","minimum":0,"multipleOf":0.01},"nightMultiplier":{"type":"number","minimum":0,"default":1},"weekendMultiplier":{"type":"number","minimum":0,"default":1},"surgeMultiplier":{"type":"number","minimum":0,"default":1},"nightStartHour":{"type":"integer","minimum":0,"maximum":23,"nullable":true},"nightEndHour":{"type":"integer","minimum":0,"maximum":23,"nullable":true},"cancellationGraceSec":{"type":"integer","minimum":0,"nullable":true,"example":120},"cancellationFeeAcceptedUsd":{"type":"number","minimum":0,"multipleOf":0.01},"cancellationFeeArrivedUsd":{"type":"number","minimum":0,"multipleOf":0.01},"notes":{"type":"string","nullable":true},"deactivateOld":{"type":"boolean","default":true,"description":"Si true, desactiva reglas activas previas de la misma ciudad"}},"additionalProperties":false}}}},"parameters":[{"schema":{"type":"string"},"in":"path","name":"id","required":true}],"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"id":{"type":"string"},"city":{"type":"string"},"active":{"type":"boolean"},"baseFareUsd":{"type":"number","minimum":0,"multipleOf":0.01},"perKmUsd":{"type":"number","minimum":0,"multipleOf":0.01},"perMinUsd":{"type":"number","minimum":0,"multipleOf":0.01},"minFareUsd":{"type":"number","minimum":0,"multipleOf":0.01},"nightMultiplier":{"type":"number"},"weekendMultiplier":{"type":"number"},"surgeMultiplier":{"type":"number"},"nightStartHour":{"type":"integer","nullable":true},"nightEndHour":{"type":"integer","nullable":true},"cancellationGraceSec":{"type":"integer","nullable":true},"cancellationFeeAcceptedUsd":{"type":"number","minimum":0,"multipleOf":0.01},"cancellationFeeArrivedUsd":{"type":"number","minimum":0,"multipleOf":0.01},"validFrom":{"type":"string","format":"date-time","nullable":true},"validTo":{"type":"string","format":"date-time","nullable":true},"notes":{"type":"string","nullable":true},"createdAt":{"type":"string","format":"date-time"},"updatedAt":{"type":"string","format":"date-time"}}}}}},"404":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}}}}}}}}},"/users/me/push-token":{"post":{"operationId":"usersRegisterPushToken","summary":"Registrar FCM token","tags":["users"],"description":"Registra o actualiza el FCM token del usuario logueado.","requestBody":{"content":{"application/json":{"schema":{"type":"object","required":["fcmToken"],"properties":{"fcmToken":{"type":"string","minLength":10,"example":"d5x...:APA91bH..."}},"additionalProperties":false,"example":{"fcmToken":"d5x...:APA91bHExampleToken"}}}},"required":true},"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"ok":{"type":"boolean"}},"example":{"ok":true}}}}}}},"delete":{"operationId":"usersDeletePushToken","summary":"Eliminar FCM token","tags":["users"],"description":"Borra el FCM token asociado al usuario (logout de push notifications).","responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"ok":{"type":"boolean"}},"example":{"ok":true}}}}}}}},"/payments":{"get":{"operationId":"paymentsList","summary":"Listar pagos (ADMIN)","tags":["payments"],"description":"Lista pagos con filtros opcionales y paginacion. Si format=csv, devuelve text/csv.","parameters":[{"schema":{"type":"string"},"in":"query","name":"userId","required":false},{"schema":{"type":"string","enum":["PENDING","AUTHORIZED","PAID","FAILED","REFUNDED"]},"in":"query","name":"status","required":false},{"schema":{"type":"string"},"in":"query","name":"city","required":false},{"schema":{"type":"string","format":"date-time"},"in":"query","name":"from","required":false},{"schema":{"type":"string","format":"date-time"},"in":"query","name":"to","required":false},{"schema":{"type":"integer","minimum":1,"maximum":200,"default":50},"in":"query","name":"limit","required":false},{"schema":{"type":"string"},"in":"query","name":"cursor","required":false},{"schema":{"type":"string","enum":["json","csv"],"default":"json"},"in":"query","name":"format","required":false}],"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"items":{"type":"array","items":{"type":"object","properties":{"id":{"type":"string"},"tripId":{"type":"string"},"amountUsd":{"type":"number"},"status":{"type":"string","enum":["PENDING","AUTHORIZED","PAID","FAILED","REFUNDED"]},"method":{"type":"string"},"provider":{"type":"string","nullable":true},"externalId":{"type":"string","nullable":true},"createdAt":{"type":"string","format":"date-time"},"updatedAt":{"type":"string","format":"date-time"},"isAuthorized":{"type":"boolean"},"isPaid":{"type":"boolean"},"isFailed":{"type":"boolean"},"providerDisplay":{"type":"string"},"capturable":{"type":"boolean"}},"example":{"id":"pay_123","tripId":"trp_123","amountUsd":7.8,"status":"PAID","method":"CASH","provider":null,"externalId":null,"isAuthorized":false,"isPaid":true,"isFailed":false,"providerDisplay":"Cash","capturable":false,"createdAt":"2025-01-01T12:20:00.000Z","updatedAt":"2025-01-01T12:20:00.000Z"}}},"nextCursor":{"type":"string","nullable":true}},"example":{"items":[{"id":"pay_123","tripId":"trp_123","amountUsd":7.8,"status":"PAID","method":"CASH","provider":null,"externalId":null,"isAuthorized":false,"isPaid":true,"isFailed":false,"providerDisplay":"Cash","capturable":false,"createdAt":"2025-01-01T12:20:00.000Z","updatedAt":"2025-01-01T12:20:00.000Z"}],"nextCursor":null}}},"text/csv":{"schema":{"type":"string","example":"id,tripId,amountUsd,status,method,provider,externalId,createdAt,updatedAt,isAuthorized,isPaid,isFailed,providerDisplay,capturable\n\"pay_123\",\"trp_123\",7.8,\"PAID\",\"CASH\",\"\",\"\",\"2025-01-01T12:20:00.000Z\",\"2025-01-01T12:20:00.000Z\",false,true,false,\"Cash\",false\n"}}}}}}},"/payments/{tripId}/capture":{"post":{"operationId":"paymentsCaptureByTrip","summary":"Capturar pago autorizado (ADMIN)","tags":["payments"],"description":"Captura un PaymentIntent autorizado de Stripe para el trip.","parameters":[{"schema":{"type":"string","example":"trp_123"},"in":"path","name":"tripId","required":true}],"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"ok":{"type":"boolean"}}}}}},"400":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}}}}}},"404":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}}}}}}}}},"/payments/{tripId}/refund":{"post":{"operationId":"paymentsRefundByTrip","summary":"Refund/cancel (ADMIN)","tags":["payments"],"description":"Reembolsa un Payment capturado (Stripe) o cancela autorizacion. Para otros metodos, marca REFUNDED y registra auditoria.","requestBody":{"content":{"application/json":{"schema":{"type":"object","properties":{"amountUsd":{"type":"number"},"reason":{"type":"string"}},"additionalProperties":false,"example":{"amountUsd":2.5,"reason":"customer_request"}}}}},"parameters":[{"schema":{"type":"string","example":"trp_123"},"in":"path","name":"tripId","required":true}],"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"ok":{"type":"boolean"}}}}}},"400":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}}}}}},"404":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}}}}}}}}},"/payments/{tripId}":{"get":{"operationId":"paymentsGetByTrip","summary":"Obtener pago por tripId","tags":["payments"],"description":"Devuelve el registro de Payment asociado a un Trip. Requiere JWT y ser dueÃ±o del viaje o ADMIN.","parameters":[{"schema":{"type":"string","example":"trp_123"},"in":"path","name":"tripId","required":true}],"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"id":{"type":"string"},"tripId":{"type":"string"},"amountUsd":{"type":"number"},"status":{"type":"string","enum":["PENDING","AUTHORIZED","PAID","FAILED","REFUNDED"]},"method":{"type":"string"},"provider":{"type":"string","nullable":true},"externalId":{"type":"string","nullable":true},"createdAt":{"type":"string","format":"date-time"},"updatedAt":{"type":"string","format":"date-time"},"isAuthorized":{"type":"boolean"},"isPaid":{"type":"boolean"},"isFailed":{"type":"boolean"},"providerDisplay":{"type":"string"},"capturable":{"type":"boolean"}},"example":{"id":"pay_123","tripId":"trp_123","amountUsd":7.8,"status":"PAID","method":"CASH","provider":null,"externalId":null,"isAuthorized":false,"isPaid":true,"isFailed":false,"providerDisplay":"Cash","capturable":false,"createdAt":"2025-01-01T12:20:00.000Z","updatedAt":"2025-01-01T12:20:00.000Z"}}}}},"403":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}}}}}},"404":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}}}}}}}}},"/payments/{tripId}/receipt":{"get":{"operationId":"paymentsReceiptByTrip","summary":"Obtener recibo","tags":["payments"],"description":"Recibo simple del pago asociado al viaje. type=TRIP o CANCELLATION_FEE.","parameters":[{"schema":{"type":"string","example":"trp_123"},"in":"path","name":"tripId","required":true}],"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"tripId":{"type":"string"},"amountUsd":{"type":"number"},"currency":{"type":"string"},"method":{"type":"string"},"status":{"type":"string"},"provider":{"type":"string","nullable":true},"type":{"type":"string","enum":["TRIP","CANCELLATION_FEE"]},"paidAt":{"type":"string","format":"date-time","nullable":true}},"example":{"tripId":"trp_123","amountUsd":2,"currency":"USD","method":"CARD","status":"PAID","provider":"Stripe","type":"CANCELLATION_FEE","paidAt":"2025-01-01T12:00:00.000Z"}}}}},"404":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}}}}}}}}},"/payments/{tripId}/refunds":{"get":{"operationId":"paymentsRefundsByTrip","summary":"Refunds por tripId","tags":["payments"],"description":"Lista auditorias de reembolso/cancelaciÃ³n del pago de un trip. Requiere JWT y ser dueÃ±o del viaje o ADMIN.","parameters":[{"schema":{"type":"string","example":"trp_123"},"in":"path","name":"tripId","required":true}],"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"items":{"type":"array","items":{"type":"object","properties":{"id":{"type":"string"},"paymentId":{"type":"string"},"tripId":{"type":"string"},"amountUsd":{"type":"number"},"reason":{"type":"string","nullable":true},"provider":{"type":"string","nullable":true},"externalId":{"type":"string","nullable":true},"createdAt":{"type":"string","format":"date-time"}}}}},"example":{"items":[{"id":"re_1","paymentId":"pay_1","tripId":"trp_1","amountUsd":1.5,"reason":"admin_refund","provider":"Stripe","externalId":"re_123","createdAt":"2025-01-01T12:00:00.000Z"}]}}}}},"403":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}}}}}},"404":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}}}}}}}}},"/admin/refunds":{"get":{"operationId":"adminRefundsList","summary":"Listar refunds (ADMIN)","tags":["payments"],"description":"Lista auditorias de reembolso/cancelaciÃ³n con filtros y CSV. Si format=csv, devuelve text/csv.","parameters":[{"schema":{"type":"string"},"in":"query","name":"userId","required":false},{"schema":{"type":"string"},"in":"query","name":"city","required":false},{"schema":{"type":"string","format":"date-time"},"in":"query","name":"from","required":false},{"schema":{"type":"string","format":"date-time"},"in":"query","name":"to","required":false},{"schema":{"type":"integer","minimum":1,"maximum":200,"default":50},"in":"query","name":"limit","required":false},{"schema":{"type":"string"},"in":"query","name":"cursor","required":false},{"schema":{"type":"string","enum":["json","csv"],"default":"json"},"in":"query","name":"format","required":false}],"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"items":{"type":"array","items":{"type":"object","properties":{"id":{"type":"string"},"paymentId":{"type":"string"},"tripId":{"type":"string"},"amountUsd":{"type":"number"},"reason":{"type":"string","nullable":true},"provider":{"type":"string","nullable":true},"externalId":{"type":"string","nullable":true},"createdAt":{"type":"string","format":"date-time"}}}},"nextCursor":{"type":"string","nullable":true}}}},"text/csv":{"schema":{"type":"string","example":"id,paymentId,tripId,amountUsd,reason,provider,externalId,createdAt\n\"re_1\",\"pay_1\",\"trp_1\",1.5,\"admin_refund\",\"Stripe\",\"re_123\",\"2025-01-01T12:00:00.000Z\"\n"}}}}}}},"/webhooks/stripe":{"post":{"operationId":"webhooksStripe","summary":"Stripe webhook","tags":["payments"],"security":[],"responses":{"200":{"description":"Default Response"}}}},"/payments/setup-intent":{"post":{"operationId":"paymentsCreateSetupIntent","summary":"Crear SetupIntent","tags":["payments"],"description":"Rider crea un SetupIntent para guardar una tarjeta. Devuelve client_secret.","responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"clientSecret":{"type":"string"}}}}}},"400":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}}}}}},"404":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}}}}}}}}},"/payments/set-default":{"post":{"operationId":"paymentsSetDefaultMethod","summary":"Definir PM por defecto","tags":["payments"],"description":"Guarda el paymentMethod como predeterminado en Stripe y DB.","requestBody":{"content":{"application/json":{"schema":{"type":"object","required":["paymentMethodId"],"properties":{"paymentMethodId":{"type":"string","example":"pm_123"}}}}},"required":true},"responses":{"200":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"ok":{"type":"boolean"}}}}}},"400":{"description":"Default Response","content":{"application/json":{"schema":{"type":"object","properties":{"error":{"type":"string"}}}}}}}}}},"servers":[{"url":"http://localhost:8080"}],"security":[{"bearerAuth":[]}]}