// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum Role {
  ADMIN
  DRIVER
  RIDER
}

enum DriverStatus {
  OFFLINE
  IDLE
  ON_TRIP
  SUSPENDED
}

enum TripStatus {
  REQUESTED
  ASSIGNED
  ACCEPTED
  ARRIVED
  STARTED
  COMPLETED
  CANCELED
}

enum PaymentStatus {
  PENDING
  AUTHORIZED
  PAID
  FAILED
  REFUNDED
}

enum VehicleType {
  SEDAN
  SUV
  VAN
  MOTORCYCLE
  TRUCK
}

// Models
model User {
  id                           String   @id @default(cuid())
  email                        String   @unique
  phone                        String?  @unique
  fcmToken                     String?
  stripeCustomerId             String?
  stripeDefaultPaymentMethodId String?
  passwordHash                 String
  firstName                    String
  lastName                     String
  role                         Role     @default(RIDER)
  isActive                     Boolean  @default(true)
  createdAt                    DateTime @default(now())
  updatedAt                    DateTime @updatedAt

  driverProfile DriverProfile?
  riderProfile  RiderProfile?

  tripsAsRider  Trip[] @relation("RiderTrips")
  tripsAsDriver Trip[] @relation("DriverTrips")

  @@index([role])
  @@index([isActive])
}

model RiderProfile {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DriverProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  licenseNumber    String       @unique
  licenseExpiresAt DateTime?
  status           DriverStatus @default(OFFLINE)

  currentLat        Decimal?  @db.Decimal(9, 6)
  currentLng        Decimal?  @db.Decimal(9, 6)
  locationUpdatedAt DateTime?

  rating     Decimal? @db.Decimal(3, 2)
  totalTrips Int      @default(0)
  documents  Json?

  vehicle   Vehicle?
  locations DriverLocationHistory[] @relation("DriverLocationHistoryByDriver")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([locationUpdatedAt])
  @@index([currentLat, currentLng])
}

model Vehicle {
  id       String        @id @default(cuid())
  driverId String        @unique
  driver   DriverProfile @relation(fields: [driverId], references: [id], onDelete: Cascade)

  type     VehicleType
  plate    String      @unique
  brand    String
  model    String
  color    String?
  year     Int?
  seats    Int         @default(4)
  isActive Boolean     @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  trips Trip[]
}

model Trip {
  id String @id @default(cuid())

  riderId String
  rider   User   @relation("RiderTrips", fields: [riderId], references: [id])

  driverId String?
  driver   User?   @relation("DriverTrips", fields: [driverId], references: [id])

  vehicleId String?
  vehicle   Vehicle? @relation(fields: [vehicleId], references: [id])

  status TripStatus @default(REQUESTED)

  requestedAt  DateTime  @default(now())
  assignedAt   DateTime?
  acceptedAt   DateTime?
  arrivedAt    DateTime?
  startedAt    DateTime?
  completedAt  DateTime?
  canceledAt   DateTime?
  cancelReason String?

  pickupLat     Decimal @db.Decimal(9, 6)
  pickupLng     Decimal @db.Decimal(9, 6)
  pickupAddress String?

  dropoffLat     Decimal @db.Decimal(9, 6)
  dropoffLng     Decimal @db.Decimal(9, 6)
  dropoffAddress String?

  distanceKm  Decimal? @db.Decimal(10, 3)
  durationMin Int?
  costUsd     Decimal? @db.Decimal(10, 2)
  currency    String   @default("USD")

  city   String?
  pricingSnapshot Json?

  payment Payment?
  refunds PaymentRefund[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status, requestedAt])
  @@index([city])
  @@index([driverId])
  @@index([riderId])
}

model Payment {
  id     String @id @default(cuid())
  tripId String @unique
  trip   Trip   @relation(fields: [tripId], references: [id], onDelete: Cascade)

  amountUsd  Decimal       @db.Decimal(10, 2)
  status     PaymentStatus @default(PENDING)
  method     String
  provider   String?
  externalId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  refunds PaymentRefund[]

  @@index([status])
}

model PaymentRefund {
  id        String  @id @default(cuid())
  paymentId String
  payment   Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  tripId    String
  trip      Trip    @relation(fields: [tripId], references: [id], onDelete: Cascade)

  amountUsd  Decimal  @db.Decimal(10, 2)
  reason     String?
  provider   String?
  externalId String?
  createdAt  DateTime @default(now())

  @@index([paymentId])
  @@index([tripId, createdAt(sort: Desc)])
}

model TariffRule {
  id     String  @id @default(cuid())
  city   String
  active Boolean @default(true)

  baseFareUsd Decimal @db.Decimal(10, 2)
  perKmUsd    Decimal @db.Decimal(10, 2)
  perMinUsd   Decimal @db.Decimal(10, 2)
  minFareUsd  Decimal @default(0) @db.Decimal(10, 2)

  nightMultiplier   Decimal @default(1.00) @db.Decimal(4, 2)
  weekendMultiplier Decimal @default(1.00) @db.Decimal(4, 2)
  surgeMultiplier   Decimal @default(1.00) @db.Decimal(4, 2)

  nightStartHour Int?
  nightEndHour   Int?

  // Cancellation policy (optional, overrides env if present)
  cancellationGraceSec       Int?
  cancellationFeeAcceptedUsd Decimal? @db.Decimal(10, 2)
  cancellationFeeArrivedUsd  Decimal? @db.Decimal(10, 2)

  validFrom DateTime?
  validTo   DateTime?
  notes     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([city, active])
}

model DriverLocationHistory {
  id         String        @id @default(cuid())
  driverId   String
  driver     DriverProfile @relation("DriverLocationHistoryByDriver", fields: [driverId], references: [id], onDelete: Cascade)
  lat        Decimal       @db.Decimal(9, 6)
  lng        Decimal       @db.Decimal(9, 6)
  recordedAt DateTime      @default(now())

  @@index([driverId, recordedAt(sort: Desc)])
}
