(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[970],{2845:function(e,t,n){Promise.resolve().then(n.bind(n,2071))},2071:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return u}});var r=n(7437),i=n(2265),l=n(2800),a=n(4282),o=n(7138),s=n(5155),c=n(2268),d=n(21);function u(e){var t,n;let{params:u}=e,{id:h}=u,[p,m]=(0,i.useState)(null),[v,y]=(0,i.useState)(!0),[x,j]=(0,i.useState)(null),[b,N]=(0,i.useState)(!0),[w,C]=(0,i.useState)(!0),[S,k]=(0,i.useState)([]),L=(0,i.useRef)(null),[E,T]=(0,i.useState)(null);async function A(){let e=(0,a.oC)();if(!e){location.href="/login";return}try{let t=await (0,l.j)("/trips/".concat(encodeURIComponent(h),"/driver-location"),{},e);T({lat:t.lat,lng:t.lng,at:t.locationUpdatedAt})}catch(e){alert((null==e?void 0:e.message)||"No se pudo obtener ubicaci\xf3n")}}return((0,i.useEffect)(()=>{let e=(0,a.PR)();if(!e){location.replace("/login");return}if("ADMIN"!==e.role){j("Acceso solo para ADMIN"),y(!1);return}let t=(0,a.oC)();if(!t){location.replace("/login");return}(0,l.j)("/trips/".concat(encodeURIComponent(h)),{},t).then(e=>m(e.trip)).catch(e=>j((null==e?void 0:e.message)||"Error al cargar el trip")).finally(()=>y(!1))},[h]),(0,i.useEffect)(()=>{if(!b)return;let e=(0,a.oC)();if(e){if(w){let t=new AbortController;return L.current=t,(0,s.Z)("".concat("http://localhost:8081","/trips/").concat(encodeURIComponent(h),"/sse"),{token:e,signal:t.signal,onEvent:e=>{var t,n,r,i,l;k(t=>[e,...t].slice(0,50)),(null==e?void 0:null===(t=e.data)||void 0===t?void 0:t.status)&&m(t=>({...t||{},status:e.data.status})),"LOCATION"===((null==e?void 0:e.event)||(null==e?void 0:null===(n=e.data)||void 0===n?void 0:n.type)||"").toUpperCase()&&(null==e?void 0:null===(r=e.data)||void 0===r?void 0:r.lat)!=null&&(null==e?void 0:null===(i=e.data)||void 0===i?void 0:i.lng)!=null&&T({lat:Number(e.data.lat),lng:Number(e.data.lng),at:(null==e?void 0:null===(l=e.data)||void 0===l?void 0:l.at)||new Date().toISOString()})}}).catch(()=>{C(!1)}),()=>t.abort()}{let e=!1,t=async()=>{let t=(0,a.oC)();if(t)try{let n=await (0,l.j)("/trips/".concat(encodeURIComponent(h)),{},t);if(e)return;m(e=>({...e||{},...n.trip||{}}))}catch(e){}},n=setInterval(t,5e3);return t(),()=>{e=!0,clearInterval(n)}}}},[b,w,h]),v)?(0,r.jsxs)("div",{className:"card",children:[(0,r.jsxs)("div",{className:"row",style:{justifyContent:"space-between"},children:[(0,r.jsx)(d.qM,{height:24,width:240}),(0,r.jsxs)("div",{className:"row",style:{gap:8},children:[(0,r.jsx)(d.qM,{height:32,width:120}),(0,r.jsx)(d.qM,{height:32,width:140})]})]}),(0,r.jsx)("div",{style:{marginTop:10},children:(0,r.jsx)(d.ik,{lines:2})}),(0,r.jsx)("div",{style:{marginTop:16},children:(0,r.jsx)(d.qM,{height:360})}),(0,r.jsxs)("div",{className:"row",style:{gap:8,marginTop:12},children:[(0,r.jsx)(d.qM,{height:32,width:160}),(0,r.jsx)(d.qM,{height:32,width:160}),(0,r.jsx)(d.qM,{height:32,width:160})]})]}):x?(0,r.jsx)("div",{style:{color:"var(--danger)"},children:x}):p?(0,r.jsxs)("div",{className:"card",children:[(0,r.jsxs)("div",{className:"row",style:{justifyContent:"space-between"},children:[(0,r.jsxs)("h2",{children:["Trip ",p.id]}),(0,r.jsxs)("div",{className:"row",style:{gap:8},children:["COMPLETED"!==p.status&&"CANCELED"!==p.status&&(0,r.jsx)("button",{className:"btn secondary",onClick:g,children:"Cancelar"}),(0,r.jsxs)("button",{className:"btn secondary",onClick:()=>N(e=>!e),children:[b?"Pausar":"Reanudar"," auto-refresh"]}),(0,r.jsx)("button",{className:"btn secondary",onClick:()=>C(e=>!e),children:w?"Usar polling":"Usar SSE"}),(0,r.jsx)(o.default,{className:"btn secondary",href:"/admin/trips",children:"Volver"})]})]}),(0,r.jsxs)("p",{className:"muted",children:["Status: ",p.status]}),(0,r.jsxs)("div",{className:"row",style:{gap:24},children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("strong",{children:"Rider"}),(0,r.jsx)("div",{className:"muted",children:p.riderId||"-"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("strong",{children:"Driver"}),(0,r.jsx)("div",{className:"muted",children:p.driverId||"-"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("strong",{children:"Ciudad"}),(0,r.jsx)("div",{className:"muted",children:p.city||"-"})]})]}),(0,r.jsxs)("div",{style:{marginTop:16},children:[(0,r.jsx)("strong",{children:"Fechas"}),(0,r.jsxs)("div",{className:"muted",children:["requested: ",f(p.requestedAt)," \xb7 started: ",f(p.startedAt)," \xb7 completed: ",f(p.completedAt)]})]}),(0,r.jsxs)("div",{style:{marginTop:16},children:[(0,r.jsx)("strong",{children:"Coordenadas"}),(0,r.jsx)("pre",{className:"card",style:{overflow:"auto"},children:JSON.stringify({origin:p.origin,destination:p.destination},null,2)})]}),(0,r.jsxs)("div",{style:{marginTop:16},children:[(0,r.jsx)("strong",{children:"Mapa"}),(0,r.jsx)("div",{className:"card",style:{padding:0},children:(0,r.jsx)(c.Z,{origin:(null==p?void 0:p.origin)&&"number"==typeof p.origin.lat&&"number"==typeof p.origin.lng?{lat:p.origin.lat,lng:p.origin.lng}:(null==p?void 0:p.pickupLat)!=null&&(null==p?void 0:p.pickupLng)!=null?{lat:Number(p.pickupLat),lng:Number(p.pickupLng)}:null,destination:(null==p?void 0:p.destination)&&"number"==typeof p.destination.lat&&"number"==typeof p.destination.lng?{lat:p.destination.lat,lng:p.destination.lng}:(null==p?void 0:p.dropoffLat)!=null&&(null==p?void 0:p.dropoffLng)!=null?{lat:Number(p.dropoffLat),lng:Number(p.dropoffLng)}:null,driver:E&&null!=E.lat&&null!=E.lng?{lat:Number(E.lat),lng:Number(E.lng)}:void 0,height:360})})]}),(0,r.jsxs)("div",{style:{marginTop:16},children:[(0,r.jsx)("strong",{children:"Driver (ubicaci\xf3n actual)"}),(0,r.jsxs)("div",{className:"row",style:{gap:8},children:[(0,r.jsx)("button",{className:"btn secondary",onClick:A,children:"Actualizar ubicaci\xf3n"}),E&&(0,r.jsxs)("span",{className:"muted",children:[null!==(t=E.lat)&&void 0!==t?t:"-",", ",null!==(n=E.lng)&&void 0!==n?n:"-"," â€¢ ",E.at?new Date(E.at).toLocaleString():"-"]})]})]}),(0,r.jsxs)("div",{style:{marginTop:16},children:[(0,r.jsx)("strong",{children:"Pricing"}),(0,r.jsx)("pre",{className:"card",style:{overflow:"auto"},children:JSON.stringify(p.pricing||{},null,2)})]}),(0,r.jsxs)("div",{style:{marginTop:16},children:[(0,r.jsx)("strong",{children:"Eventos"}),0===S.length?(0,r.jsx)("div",{className:"muted",children:"Sin eventos a\xfan."}):(0,r.jsx)("ul",{style:{listStyle:"none",padding:0,margin:0},children:S.map((e,t)=>(0,r.jsxs)("li",{className:"card",style:{marginTop:8},children:[(0,r.jsx)("div",{className:"muted",children:e.event||"message"}),(0,r.jsx)("pre",{style:{overflow:"auto"},children:JSON.stringify(e.data,null,2)})]},t))})]})]}):(0,r.jsx)("div",{children:"No encontrado"})}function f(e){if(!e)return"-";try{return new Date(e).toLocaleString()}catch(t){return e}}async function g(){if(!confirm("\xbfSeguro que deseas cancelar este viaje?"))return;let e=prompt("Motivo de cancelaci\xf3n (opcional):","ADMIN_PANEL"),t=(0,a.oC)();if(!t){location.href="/login";return}try{await (0,l.j)("/trips/".concat(encodeURIComponent(location.pathname.split("/").pop()||""),"/cancel"),{method:"POST",body:JSON.stringify({reason:e||"ADMIN_PANEL"})},t),location.reload()}catch(e){alert((null==e?void 0:e.message)||"No se pudo cancelar")}}},2268:function(e,t,n){"use strict";n.d(t,{Z:function(){return l}});var r=n(7437),i=n(2265);function l(e){let{origin:t,destination:n,driver:l,height:a=320,controls:o=!1}=e,s=i.useRef(null),c=i.useRef(null),d=i.useRef({}),u=i.useRef(!1);function f(){let e=window.L;if(!e||!c.current)return;let r=c.current,i=d.current,a=(t,n)=>e.circleMarker([t.lat,t.lng],{radius:8,color:n,weight:2,fillColor:n,fillOpacity:.6});t&&isFinite(t.lat)&&isFinite(t.lng)?i.origin?i.origin.setLatLng([t.lat,t.lng]):i.origin=a(t,"#22c55e").addTo(r):i.origin&&(r.removeLayer(i.origin),i.origin=void 0),n&&isFinite(n.lat)&&isFinite(n.lng)?i.destination?i.destination.setLatLng([n.lat,n.lng]):i.destination=a(n,"#ef4444").addTo(r):i.destination&&(r.removeLayer(i.destination),i.destination=void 0),l&&isFinite(l.lat)&&isFinite(l.lng)?i.driver?i.driver.setLatLng([l.lat,l.lng]):i.driver=a(l,"#4f46e5").addTo(r):i.driver&&(r.removeLayer(i.driver),i.driver=void 0)}function g(){let e=window.L;if(!e||!c.current)return;let r=[];if(t&&r.push(t),n&&r.push(n),l&&r.push(l),0===r.length)return;let i=e.latLngBounds(r.map(e=>[e.lat,e.lng]));c.current.fitBounds(i.pad(.25),{maxZoom:16})}return i.useEffect(()=>{let e=!1;return(async function(){return!!window.L||(await new Promise(e=>{let t=document.querySelector("link[data-leaflet]"),n=document.querySelector("script[data-leaflet]");if(!t){let e=document.createElement("link");e.rel="stylesheet",e.href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css",e.setAttribute("data-leaflet","1"),document.head.appendChild(e)}if(n){e();return}let r=document.createElement("script");r.src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js",r.async=!0,r.defer=!0,r.setAttribute("data-leaflet","1"),r.onload=()=>e(),r.onerror=()=>e(),document.body.appendChild(r)}),!!window.L)})().then(t=>{if(e||!t)return;let n=window.L;if(s.current){if(!c.current){let e=s.current,t=n.map(e,{zoomControl:!0});t.setView([0,0],2),n.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(t),c.current=t}u.current=!0,f(),g()}}),()=>{e=!0}},[]),i.useEffect(()=>{u.current&&(f(),g())},[JSON.stringify(t),JSON.stringify(n)]),i.useEffect(()=>{u.current&&f()},[JSON.stringify(l)]),(0,r.jsxs)("div",{style:{position:"relative",width:"100%",height:a},children:[(0,r.jsx)("div",{ref:s,style:{width:"100%",height:"100%"}}),o&&(0,r.jsxs)("div",{style:{position:"absolute",top:8,right:8,display:"flex",flexDirection:"column",gap:6},children:[(0,r.jsx)("button",{className:"btn secondary","aria-label":"Centrar a origen",onClick:()=>h(t),children:"Origen"}),(0,r.jsx)("button",{className:"btn secondary","aria-label":"Centrar a destino",onClick:()=>h(n),children:"Destino"}),(0,r.jsx)("button",{className:"btn secondary","aria-label":"Centrar a conductor",onClick:()=>h(l),children:"Driver"}),(0,r.jsx)("button",{className:"btn secondary","aria-label":"Encajar todo",onClick:()=>g(),children:"Reencuadrar"})]})]});function h(e){window.L&&c.current&&e&&isFinite(e.lat)&&isFinite(e.lng)&&c.current.setView([e.lat,e.lng],Math.max(14,c.current.getZoom()||14),{animate:!0})}}},21:function(e,t,n){"use strict";n.d(t,{ik:function(){return l},qM:function(){return i}});var r=n(7437);function i(e){let{height:t=16,width:n="100%",style:i,className:l}=e;return(0,r.jsx)("div",{className:l,style:{height:t,width:n,background:"linear-gradient(90deg, rgba(255,255,255,0.06) 25%, rgba(255,255,255,0.12) 37%, rgba(255,255,255,0.06) 63%)",backgroundSize:"400% 100%",animation:"skeleton 1.2s ease-in-out infinite",borderRadius:8,...i}})}function l(e){let{lines:t=3}=e;return(0,r.jsx)("div",{className:"row",style:{gap:8,flexDirection:"column"},children:Array.from({length:t}).map((e,t)=>(0,r.jsx)(i,{height:12,width:"".concat(80-8*t,"%")},t))})}if(n(2265),!document.getElementById("sk-keyframes")){let e=document.createElement("style");e.id="sk-keyframes",e.innerHTML="@keyframes skeleton { 0%{background-position:100% 50%} 100%{background-position:0 50%} }",document.head.appendChild(e)}},2800:function(e,t,n){"use strict";n.d(t,{S:function(){return r},j:function(){return i}});let r="http://localhost:8081";async function i(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2?arguments[2]:void 0,i=new Headers(t.headers||{});i.set("Content-Type","application/json"),n&&i.set("Authorization","Bearer ".concat(n));let l=await fetch("".concat(r).concat(e),{...t,headers:i,cache:"no-store"});if(!l.ok){let e=await l.text().catch(()=>"");throw Error("API ".concat(l.status,": ").concat(e||l.statusText))}return l.json()}},4282:function(e,t,n){"use strict";n.d(t,{DH:function(){return s},J1:function(){return a},PR:function(){return o},oC:function(){return c}});var r=n(6300).Buffer;let i="taxi_token",l="taxi_user";function a(e,t){localStorage.setItem(i,e),localStorage.setItem(l,JSON.stringify(t))}function o(){let e=localStorage.getItem(l);if(!e)return null;try{return JSON.parse(e)}catch(e){return null}}function s(){localStorage.removeItem(i),localStorage.removeItem(l)}function c(){let e=localStorage.getItem(i);return e?!function(e){let t=function(e){let t=e.split(".");if(3!==t.length)return null;try{let e=function(e){try{let t=e.length%4==2?"==":e.length%4==3?"=":e.length%4==1?"===":"",n=e.replace(/-/g,"+").replace(/_/g,"/")+t;if("function"==typeof atob)return atob(n);return r.from(n,"base64").toString("binary")}catch(e){return""}}(t[1]);return JSON.parse(e)}catch(e){return null}}(e);return null!=t&&!!t.exp&&Math.floor(Date.now()/1e3)>=t.exp}(e)?e:(s(),null):null}},5155:function(e,t,n){"use strict";async function r(e,t){let n=new AbortController,r=t.signal?function(e,t){if(e.aborted)return e;if(t.aborted)return t;let n=new AbortController,r=()=>n.abort();return e.addEventListener("abort",r),t.addEventListener("abort",r),n.signal}(n.signal,t.signal):n.signal,i=await fetch(e,{method:"GET",headers:{Accept:"text/event-stream",...t.token?{Authorization:"Bearer ".concat(t.token)}:{}},cache:"no-store",signal:r});if(!i.ok||!i.body)throw Error("SSE HTTP ".concat(i.status));let l=i.body.getReader(),a=new TextDecoder("utf-8"),o="",s=!1;return(async()=>{try{for(;;){let e;let{value:n,done:r}=await l.read();if(r)break;for(o+=a.decode(n,{stream:!0});-1!==(e=o.indexOf("\n\n"));){let n=o.slice(0,e);o=o.slice(e+2);let r=function(e){let t;let n=e.split(/\r?\n/),r=[];for(let e of n){if(!e||e.startsWith(":"))continue;let n=e.indexOf(":"),i=-1===n?e:e.slice(0,n),l=-1===n?"":e.slice(n+1).replace(/^ /,"");"event"===i?t=l:"data"===i&&r.push(l)}let i=r.join("\n"),l=i;try{l=i?JSON.parse(i):void 0}catch(e){}return t||i?{event:t,data:l}:null}(n);r&&t.onEvent(r)}}}catch(e){}finally{s||n.abort()}})(),{close:()=>{s=!0,n.abort()}}}n.d(t,{Z:function(){return r}})}},function(e){e.O(0,[300,138,971,23,744],function(){return e(e.s=2845)}),_N_E=e.O()}]);