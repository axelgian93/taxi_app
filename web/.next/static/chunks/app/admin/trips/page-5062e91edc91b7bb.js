(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[661],{5828:function(e,t,r){Promise.resolve().then(r.bind(r,4779))},6463:function(e,t,r){"use strict";var n=r(1169);r.o(n,"useParams")&&r.d(t,{useParams:function(){return n.useParams}}),r.o(n,"useRouter")&&r.d(t,{useRouter:function(){return n.useRouter}}),r.o(n,"useSearchParams")&&r.d(t,{useSearchParams:function(){return n.useSearchParams}})},4779:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return u}});var n=r(7437),a=r(2265),s=r(7138),i=r(6463),l=r(2800),c=r(4282),o=r(21);function u(){let[e,t]=(0,a.useState)([]),[r,u]=(0,a.useState)(!0),[m,f]=(0,a.useState)(null),[p,g]=(0,a.useState)(void 0),[x,j]=(0,a.useState)(!1),[y,v]=(0,a.useState)(""),C=(0,i.useSearchParams)(),S=(0,i.useRouter)(),[N,E]=(0,a.useState)(C.get("status")||""),[b,w]=(0,a.useState)(C.get("city")||""),[D,I]=(0,a.useState)(C.get("from")||""),[A,R]=(0,a.useState)(C.get("to")||""),[T,L]=(0,a.useState)(()=>{let e=Number(C.get("pages")||"1");return isFinite(e)&&e>=1?Math.floor(e):1}),M=(0,a.useMemo)(()=>{let e=new URLSearchParams;return e.set("limit","50"),N&&e.set("status",N),b&&e.set("city",b),D&&e.set("from",D),A&&e.set("to",A),e.toString()},[N,b,D,A]),[k,P]=(0,a.useState)(!0),[q,O]=(0,a.useState)({}),_=(0,a.useMemo)(()=>{let t=D?Date.parse(D):null,r=A?Date.parse(A+"T23:59:59"):null;return e.filter(e=>{if(N&&e.status!==N||b&&(e.city||"").toLowerCase()!==b.toLowerCase())return!1;if(t||r){let n=e.requestedAt?Date.parse(e.requestedAt):NaN;if(!isFinite(n)||t&&n<t||r&&n>r)return!1}return!y||!!e.id.toLowerCase().includes(y.trim().toLowerCase())})},[e,N,b,D,A,y]);async function U(){let e=(0,c.oC)();if(e&&p){u(!0);try{let r=M?"&":"",n=await (0,l.j)("/admin/trips?".concat(M).concat(r,"cursor=").concat(encodeURIComponent(p)),{},e);t(e=>[...e,...n.items||[]]),g(n.nextCursor),j(!!n.nextCursor)}catch(e){f((null==e?void 0:e.message)||"Error al cargar m\xe1s trips")}finally{u(!1)}}}return((0,a.useEffect)(()=>{let e=(0,c.PR)();if(!e){location.replace("/login");return}if("ADMIN"!==e.role){f("Acceso solo para ADMIN"),u(!1);return}let r=(0,c.oC)();if(!r){location.replace("/login");return}let n=new URL(location.href),a=new URLSearchParams(M);T&&T>1&&a.set("pages",String(T)),n.search=a.toString(),window.history.replaceState(null,"",n.toString()),(0,l.j)("/admin/trips?".concat(M),{},r).then(e=>{t(e.items||[]),g(e.nextCursor),j(!!e.nextCursor)}).catch(e=>f((null==e?void 0:e.message)||"Error al cargar trips")).finally(()=>u(!1))},[M,T]),(0,a.useEffect)(()=>{let t=Math.max(1,T),r=Math.max(1,Math.ceil((e.length||0)/50));if(!x||r>=t)return;let n=!1;return(async()=>{for(let e=r;e<t&&!n;e++)await U()})(),()=>{n=!0}},[T,e.length,x]),(0,a.useEffect)(()=>{if(!k)return;let e=!1,r=async()=>{let r=(0,c.oC)();if(r)try{let n=await (0,l.j)("/admin/trips?".concat(M),{},r);if(e)return;t(e=>{let t=new Map(e.map(e=>[e.id,e])),r=n.items||[],a=[],s=r.map(e=>{let r=t.get(e.id);return r?((r.status!==e.status||r.driverId!==e.driverId||r.riderId!==e.riderId)&&a.push(e.id),{...r,...e}):(a.push(e.id),e)}),i=new Set(r.map(e=>e.id)),l=e.filter(e=>!i.has(e.id)),c=[...s,...l];if(a.length){let e=Date.now();O(t=>{let r={...t};return a.forEach(t=>{r[t]=e+2500}),r}),setTimeout(()=>{O(e=>{let t=Date.now(),r={};for(let[n,a]of Object.entries(e))a>t&&(r[n]=a);return r})},3e3)}return g(n.nextCursor),j(!!n.nextCursor),c})}catch(e){}},n=setInterval(r,5e3);return r(),()=>{e=!0,clearInterval(n)}},[k,M]),r)?(0,n.jsxs)("div",{children:[(0,n.jsx)("h2",{children:"Trips"}),(0,n.jsx)("div",{className:"card",style:{marginTop:10},children:(0,n.jsxs)("div",{className:"row",style:{gap:8},children:[(0,n.jsx)(o.qM,{height:32,width:140}),(0,n.jsx)(o.qM,{height:32,width:140}),(0,n.jsx)(o.qM,{height:32,width:180}),(0,n.jsx)(o.qM,{height:32,width:180})]})}),(0,n.jsx)("div",{className:"table-wrap",style:{marginTop:10},children:(0,n.jsx)(o.qM,{height:240})})]}):m?(0,n.jsx)("div",{style:{color:"var(--danger)"},children:m}):(0,n.jsxs)("div",{children:[(0,n.jsx)("h2",{children:"Trips"}),(0,n.jsxs)("div",{className:"row",style:{justifyContent:"space-between",margin:"8px 0",alignItems:"center"},children:[(0,n.jsxs)("div",{className:"row",style:{gap:8,flexWrap:"wrap"},children:[["","REQUESTED","ASSIGNED","ACCEPTED","ARRIVED","STARTED","COMPLETED","CANCELED"].map(e=>(0,n.jsx)("button",{className:"btn ".concat(N===e?"":"secondary"),onClick:()=>E(e),"aria-pressed":N===e,"aria-label":"Filtro ".concat(e||"Todos"),children:e||"Todos"},e||"ALL")),(0,n.jsxs)("label",{className:"row",style:{gap:6,alignItems:"center"},children:[(0,n.jsx)("span",{className:"muted",children:"Buscar ID"}),(0,n.jsx)("input",{"aria-label":"Buscar por ID",placeholder:"trp_...",value:y,onChange:e=>v(e.target.value)})]})]}),(0,n.jsx)("button",{className:"btn secondary",onClick:()=>(function(e){let t=["id","status","riderId","driverId","city","requestedAt"],r=e.map(e=>t.map(t=>{var r;return String(null!==(r=e[t])&&void 0!==r?r:"")})),n=new Blob([[t.join(","),...r.map(e=>e.map(e=>/[,"]/.test(e)?'"'.concat(e.replace(/"/g,'""'),'"'):e).join(","))].join("\n")+"\n"],{type:"text/csv;charset=utf-8;"}),a=URL.createObjectURL(n),s=document.createElement("a");s.href=a,s.download="trips_export_".concat(new Date().toISOString().slice(0,19).replace(/[:T]/g,"-"),".csv"),document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(a)})(_),style:{marginRight:8},children:"Export CSV"}),(0,n.jsxs)("button",{className:"btn secondary",onClick:()=>P(e=>!e),children:[k?"Pausar":"Reanudar"," auto-refresh"]})]}),(0,n.jsx)(d,{status:N,city:b,from:D,to:A,onChange:e=>{t([]),g(void 0),j(!1),E(e.status),w(e.city),I(e.from),R(e.to);let r=new URLSearchParams;e.status&&r.set("status",e.status),e.city&&r.set("city",e.city),e.from&&r.set("from",e.from),e.to&&r.set("to",e.to),r.set("pages","1");let n=r.toString();S.replace("/admin/trips".concat(n?"?".concat(n):""))}}),0!==_.length||r?null:(0,n.jsx)("div",{className:"muted",style:{marginTop:8},children:"Sin resultados con los filtros actuales."}),(0,n.jsxs)("table",{className:"table",children:[(0,n.jsx)("thead",{children:(0,n.jsxs)("tr",{children:[(0,n.jsx)("th",{children:"ID"}),(0,n.jsx)("th",{children:"Status"}),(0,n.jsx)("th",{children:"Rider"}),(0,n.jsx)("th",{children:"Driver"}),(0,n.jsx)("th",{children:"Ciudad"}),(0,n.jsx)("th",{children:"Requested"}),(0,n.jsx)("th",{children:"Acciones"})]})}),(0,n.jsxs)("tbody",{children:[_.map(e=>(0,n.jsxs)("tr",{className:q[e.id]?"flash":"",children:[(0,n.jsx)("td",{children:(0,n.jsx)(s.default,{href:"/admin/trips/".concat(e.id),children:e.id})}),(0,n.jsx)("td",{children:e.status}),(0,n.jsx)("td",{className:"muted",children:e.riderId||"-"}),(0,n.jsx)("td",{className:"muted",children:e.driverId||"-"}),(0,n.jsx)("td",{className:"muted",children:e.city||"-"}),(0,n.jsx)("td",{className:"muted",children:function(e){if(!e)return"-";try{return new Date(e).toLocaleString()}catch(t){return e}}(e.requestedAt)}),(0,n.jsx)("td",{children:(0,n.jsx)("button",{className:"btn secondary",disabled:"COMPLETED"===e.status||"CANCELED"===e.status||r,onClick:()=>h(e.id),children:"Cancelar"})})]},e.id)),r&&(0,n.jsx)("tr",{children:(0,n.jsx)("td",{colSpan:7,children:(0,n.jsxs)("div",{className:"row",style:{gap:8},children:[(0,n.jsx)(o.qM,{height:18,width:120}),(0,n.jsx)(o.qM,{height:18,width:200}),(0,n.jsx)(o.qM,{height:18,width:160})]})})})]})]}),(0,n.jsx)("div",{style:{marginTop:12},children:x?(0,n.jsx)("button",{className:"btn",onClick:U,disabled:r,children:r?"Cargandoâ€¦":"Cargar m\xe1s"}):(0,n.jsx)("span",{className:"muted",children:"No hay m\xe1s resultados"})})]})}function d(e){let{status:t,city:r,from:a,to:s,onChange:i}=e;return(0,n.jsx)("div",{className:"card",style:{margin:"12px 0"},children:(0,n.jsxs)("div",{className:"row",style:{flexWrap:"wrap",gap:16},children:[(0,n.jsxs)("label",{children:[(0,n.jsx)("div",{className:"muted",children:"Estado"}),(0,n.jsxs)("select",{value:t,onChange:e=>i({status:e.target.value,city:r,from:a,to:s}),children:[(0,n.jsx)("option",{value:"",children:"Todos"}),(0,n.jsx)("option",{value:"ASSIGNED",children:"ASSIGNED"}),(0,n.jsx)("option",{value:"ACCEPTED",children:"ACCEPTED"}),(0,n.jsx)("option",{value:"ARRIVED",children:"ARRIVED"}),(0,n.jsx)("option",{value:"STARTED",children:"STARTED"}),(0,n.jsx)("option",{value:"COMPLETED",children:"COMPLETED"}),(0,n.jsx)("option",{value:"CANCELLED",children:"CANCELLED"})]})]}),(0,n.jsxs)("label",{children:[(0,n.jsx)("div",{className:"muted",children:"Ciudad"}),(0,n.jsx)("input",{value:r,onChange:e=>i({status:t,city:e.target.value,from:a,to:s}),placeholder:"Guayaquil",style:{padding:6,borderRadius:8}})]}),(0,n.jsxs)("label",{children:[(0,n.jsx)("div",{className:"muted",children:"Desde"}),(0,n.jsx)("input",{type:"date",value:a,onChange:e=>i({status:t,city:r,from:e.target.value,to:s})})]}),(0,n.jsxs)("label",{children:[(0,n.jsx)("div",{className:"muted",children:"Hasta"}),(0,n.jsx)("input",{type:"date",value:s,onChange:e=>i({status:t,city:r,from:a,to:e.target.value})})]}),(0,n.jsx)("button",{className:"btn secondary",onClick:()=>i({status:"",city:"",from:"",to:""}),children:"Limpiar"})]})})}async function h(e){if(!confirm("\xbfCancelar este viaje?"))return;let t=prompt("Motivo de cancelaci\xf3n (opcional):","ADMIN_PANEL"),r=(0,c.oC)();if(!r){location.href="/login";return}try{await (0,l.j)("/trips/".concat(encodeURIComponent(e),"/cancel"),{method:"POST",body:JSON.stringify({reason:t||"ADMIN_PANEL"})},r),location.href=location.href}catch(e){alert((null==e?void 0:e.message)||"No se pudo cancelar")}}},21:function(e,t,r){"use strict";r.d(t,{ik:function(){return s},qM:function(){return a}});var n=r(7437);function a(e){let{height:t=16,width:r="100%",style:a,className:s}=e;return(0,n.jsx)("div",{className:s,style:{height:t,width:r,background:"linear-gradient(90deg, rgba(255,255,255,0.06) 25%, rgba(255,255,255,0.12) 37%, rgba(255,255,255,0.06) 63%)",backgroundSize:"400% 100%",animation:"skeleton 1.2s ease-in-out infinite",borderRadius:8,...a}})}function s(e){let{lines:t=3}=e;return(0,n.jsx)("div",{className:"row",style:{gap:8,flexDirection:"column"},children:Array.from({length:t}).map((e,t)=>(0,n.jsx)(a,{height:12,width:"".concat(80-8*t,"%")},t))})}if(r(2265),!document.getElementById("sk-keyframes")){let e=document.createElement("style");e.id="sk-keyframes",e.innerHTML="@keyframes skeleton { 0%{background-position:100% 50%} 100%{background-position:0 50%} }",document.head.appendChild(e)}},2800:function(e,t,r){"use strict";r.d(t,{S:function(){return n},j:function(){return a}});let n="http://localhost:8081";async function a(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2?arguments[2]:void 0,a=new Headers(t.headers||{});a.set("Content-Type","application/json"),r&&a.set("Authorization","Bearer ".concat(r));let s=await fetch("".concat(n).concat(e),{...t,headers:a,cache:"no-store"});if(!s.ok){let e=await s.text().catch(()=>"");throw Error("API ".concat(s.status,": ").concat(e||s.statusText))}return s.json()}},4282:function(e,t,r){"use strict";r.d(t,{DH:function(){return c},J1:function(){return i},PR:function(){return l},oC:function(){return o}});var n=r(6300).Buffer;let a="taxi_token",s="taxi_user";function i(e,t){localStorage.setItem(a,e),localStorage.setItem(s,JSON.stringify(t))}function l(){let e=localStorage.getItem(s);if(!e)return null;try{return JSON.parse(e)}catch(e){return null}}function c(){localStorage.removeItem(a),localStorage.removeItem(s)}function o(){let e=localStorage.getItem(a);return e?!function(e){let t=function(e){let t=e.split(".");if(3!==t.length)return null;try{let e=function(e){try{let t=e.length%4==2?"==":e.length%4==3?"=":e.length%4==1?"===":"",r=e.replace(/-/g,"+").replace(/_/g,"/")+t;if("function"==typeof atob)return atob(r);return n.from(r,"base64").toString("binary")}catch(e){return""}}(t[1]);return JSON.parse(e)}catch(e){return null}}(e);return null!=t&&!!t.exp&&Math.floor(Date.now()/1e3)>=t.exp}(e)?e:(c(),null):null}}},function(e){e.O(0,[300,138,971,23,744],function(){return e(e.s=5828)}),_N_E=e.O()}]);