(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[101],{6518:function(e,t,n){Promise.resolve().then(n.bind(n,6999))},6463:function(e,t,n){"use strict";var r=n(1169);n.o(r,"useParams")&&n.d(t,{useParams:function(){return r.useParams}}),n.o(r,"useRouter")&&n.d(t,{useRouter:function(){return r.useRouter}}),n.o(r,"useSearchParams")&&n.d(t,{useSearchParams:function(){return r.useSearchParams}})},6999:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return u}});var r=n(7437),i=n(2265),a=n(6463),l=n(2268),o=n(5155),s=n(2800),c=n(4282),d=n(8873);function u(){let{show:e}=(0,d.p)(),t=(0,a.useSearchParams)(),[n,u]=(0,i.useState)("Guayaquil"),[h,m]=(0,i.useState)({lat:-2.170998,lng:-79.922359}),[g,p]=(0,i.useState)({lat:-2.185,lng:-79.9}),[y,x]=(0,i.useState)(null),[v,b]=(0,i.useState)([]),[j,w]=(0,i.useState)(!1);async function S(){w(!0);let t=(0,c.oC)();if(!t)return alert("Inicia sesi\xf3n");try{let n=await fetch("".concat(s.S,"/admin/demo/seed"),{method:"POST",headers:{Authorization:"Bearer ".concat(t)}});if(!n.ok)throw Error("HTTP ".concat(n.status));alert("Demo seeded: usuarios y tarifas listos (pwd 123456)"),e("Demo seeded: usuarios y tarifas listos (pwd 123456)","success")}catch(e){alert((null==e?void 0:e.message)||"Error")}finally{w(!1)}}async function k(){w(!0);let t=(0,c.oC)();if(!t)return alert("Inicia sesi\xf3n");try{let n=await fetch("".concat(s.S,"/admin/demo/reset"),{method:"POST",headers:{Authorization:"Bearer ".concat(t)}});if(!n.ok)throw Error("HTTP ".concat(n.status));x(null),b([]),alert("Demo reseteada"),e("Demo reseteada","success")}catch(e){alert((null==e?void 0:e.message)||"Error")}finally{w(!1)}}async function N(){if(!h||!g)return alert("Define origen y destino");w(!0);try{let t=(0,c.oC)();if(!t)return alert("Inicia sesi\xf3n");let r={city:n,pickupLat:h.lat,pickupLng:h.lng,dropoffLat:g.lat,dropoffLng:g.lng,distanceKm:3.2,durationMin:10},i=await (0,s.j)("/trips/request",{method:"POST",body:JSON.stringify(r)},t);x({id:i.trip.id,status:i.trip.status,pickupLat:h.lat,pickupLng:h.lng,dropoffLat:g.lat,dropoffLng:g.lng,city:n}),function(e){let t=(0,c.oC)();t&&(0,o.Z)("".concat(s.S,"/trips/").concat(encodeURIComponent(e),"/sse"),{token:t,onEvent:e=>{var t;b(t=>[e,...t].slice(0,50)),(null==e?void 0:null===(t=e.data)||void 0===t?void 0:t.status)&&x(t=>t?{...t,status:e.data.status}:t)}}).catch(()=>{})}(i.trip.id),e("Viaje solicitado","success")}catch(e){alert((null==e?void 0:e.message)||"Error")}finally{w(!1)}}async function C(){if(!y)return;let t=(0,c.oC)();if(!t)return alert("Inicia sesi\xf3n");await fetch("".concat(s.S,"/admin/demo/trips/").concat(encodeURIComponent(y.id),"/assign-driver"),{method:"POST",headers:{Authorization:"Bearer ".concat(t)}}),e("Driver asignado","success")}async function L(t){if(!y)return;let n=(0,c.oC)();if(!n)return alert("Inicia sesi\xf3n");await fetch("".concat(s.S,"/admin/demo/trips/").concat(encodeURIComponent(y.id),"/advance"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(n)},body:JSON.stringify({to:t})}),e("Avanzado a ".concat(t),"success")}return(0,i.useEffect)(()=>{try{let e=t.get("city");e&&u(e);let n=t.get("olat"),r=t.get("olng"),i=t.get("dlat"),a=t.get("dlng");n&&r&&m({lat:Number(n),lng:Number(r)}),i&&a&&p({lat:Number(i),lng:Number(a)})}catch(e){}},[]),(0,r.jsxs)("div",{children:[(0,r.jsx)("h2",{children:"Demo de Viaje"}),(0,r.jsxs)("div",{className:"muted",style:{marginBottom:8},children:["\xbfNecesitas gu\xeda? Revisa ",(0,r.jsx)("a",{href:"/admin/readme",children:"/admin/readme"})]}),(0,r.jsxs)("div",{className:"row",style:{gap:8,flexWrap:"wrap"},children:[(0,r.jsxs)("label",{children:[(0,r.jsx)("div",{className:"muted",children:"Ciudad"}),(0,r.jsx)("input",{value:n,onChange:e=>u(e.target.value)})]}),(0,r.jsx)("button",{className:"btn secondary",onClick:S,disabled:j,children:"Start Demo (seed)"}),(0,r.jsx)("button",{className:"btn secondary",onClick:k,disabled:j,children:"Reset Demo"})]}),(0,r.jsxs)("div",{className:"card",style:{marginTop:10},children:[(0,r.jsxs)("div",{className:"row",style:{gap:8,flexWrap:"wrap"},children:[(0,r.jsxs)("label",{children:[(0,r.jsx)("div",{className:"muted",children:"Origen (click en mapa)"}),(0,r.jsx)("input",{type:"text",value:h?"".concat(h.lat.toFixed(6),", ").concat(h.lng.toFixed(6)):"",readOnly:!0})]}),(0,r.jsxs)("label",{children:[(0,r.jsx)("div",{className:"muted",children:"Destino (click en mapa con ALT)"}),(0,r.jsx)("input",{type:"text",value:g?"".concat(g.lat.toFixed(6),", ").concat(g.lng.toFixed(6)):"",readOnly:!0})]}),(0,r.jsx)("button",{className:"btn",onClick:N,disabled:j||!h||!g,children:"Solicitar viaje"}),(0,r.jsx)("button",{className:"btn secondary",onClick:C,disabled:!y,children:"Asignar driver"}),(0,r.jsx)("button",{className:"btn secondary",onClick:()=>L("ACCEPTED"),disabled:!y,children:"Aceptar"}),(0,r.jsx)("button",{className:"btn secondary",onClick:()=>L("ARRIVED"),disabled:!y,children:"Llegar"}),(0,r.jsx)("button",{className:"btn secondary",onClick:()=>L("STARTED"),disabled:!y,children:"Iniciar"}),(0,r.jsx)("button",{className:"btn secondary",onClick:()=>L("COMPLETED"),disabled:!y,children:"Completar"})]}),(0,r.jsx)("div",{style:{height:360,marginTop:10},children:(0,r.jsx)(f,{origin:h,dest:g,onPick:e=>m(e),onPickAlt:e=>p(e)})})]}),y&&(0,r.jsxs)("div",{className:"card",style:{marginTop:10},children:[(0,r.jsxs)("strong",{children:["Trip ",y.id]}),(0,r.jsxs)("div",{className:"muted",children:["Status: ",y.status]}),(0,r.jsx)(l.Z,{origin:h||(y.pickupLat&&y.pickupLng?{lat:Number(y.pickupLat),lng:Number(y.pickupLng)}:null),destination:g||(y.dropoffLat&&y.dropoffLng?{lat:Number(y.dropoffLat),lng:Number(y.dropoffLng)}:null),height:300}),(0,r.jsxs)("div",{style:{marginTop:10},children:[(0,r.jsx)("strong",{children:"Eventos"}),0===v.length?(0,r.jsx)("div",{className:"muted",children:"Sin eventos a\xfan."}):(0,r.jsx)("ul",{style:{listStyle:"none",padding:0},children:v.map((e,t)=>(0,r.jsxs)("li",{className:"card",style:{marginTop:6},children:[(0,r.jsx)("div",{className:"muted",children:e.event}),(0,r.jsx)("pre",{children:JSON.stringify(e.data,null,2)})]},t))})]})]})]})}function f(e){let{origin:t,dest:n,onPick:a,onPickAlt:l}=e,o=(0,i.useRef)(null),s=(0,i.useRef)(null),c=(0,i.useRef)({});function d(e,t,n){let r=window.L,i=s.current;if(!r||!i)return;let a=c.current;a[e]?a[e].setLatLng([t.lat,t.lng]):a[e]=r.circleMarker([t.lat,t.lng],{radius:8,color:n,fillColor:n,fillOpacity:.6}).addTo(i)}return(0,i.useEffect)(()=>{let e=!1;return(async()=>{await new Promise(e=>{if(window.L)return e();let t=document.createElement("link");t.rel="stylesheet",t.href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css",document.head.appendChild(t);let n=document.createElement("script");n.src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js",n.async=!0,n.defer=!0,n.onload=()=>e(),n.onerror=()=>e(),document.body.appendChild(n)}),e||function(){var e,n;let r=window.L;if(!r||!o.current)return;let i=r.map(o.current);i.setView([null!==(e=null==t?void 0:t.lat)&&void 0!==e?e:-2.170998,null!==(n=null==t?void 0:t.lng)&&void 0!==n?n:-79.922359],13),r.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(i),s.current=i,i.on("click",e=>a({lat:e.latlng.lat,lng:e.latlng.lng})),i.on("contextmenu",e=>l({lat:e.latlng.lat,lng:e.latlng.lng}))}()})(),()=>{e=!0}},[]),(0,i.useEffect)(()=>{s.current&&t&&d("o",t,"#22c55e")},[JSON.stringify(t)]),(0,i.useEffect)(()=>{s.current&&n&&d("d",n,"#ef4444")},[JSON.stringify(n)]),(0,r.jsx)("div",{ref:o,style:{width:"100%",height:"100%"}})}},2268:function(e,t,n){"use strict";n.d(t,{Z:function(){return a}});var r=n(7437),i=n(2265);function a(e){let{origin:t,destination:n,driver:a,height:l=320,controls:o=!1}=e,s=i.useRef(null),c=i.useRef(null),d=i.useRef({}),u=i.useRef(!1);function f(){let e=window.L;if(!e||!c.current)return;let r=c.current,i=d.current,l=(t,n)=>e.circleMarker([t.lat,t.lng],{radius:8,color:n,weight:2,fillColor:n,fillOpacity:.6});t&&isFinite(t.lat)&&isFinite(t.lng)?i.origin?i.origin.setLatLng([t.lat,t.lng]):i.origin=l(t,"#22c55e").addTo(r):i.origin&&(r.removeLayer(i.origin),i.origin=void 0),n&&isFinite(n.lat)&&isFinite(n.lng)?i.destination?i.destination.setLatLng([n.lat,n.lng]):i.destination=l(n,"#ef4444").addTo(r):i.destination&&(r.removeLayer(i.destination),i.destination=void 0),a&&isFinite(a.lat)&&isFinite(a.lng)?i.driver?i.driver.setLatLng([a.lat,a.lng]):i.driver=l(a,"#4f46e5").addTo(r):i.driver&&(r.removeLayer(i.driver),i.driver=void 0)}function h(){let e=window.L;if(!e||!c.current)return;let r=[];if(t&&r.push(t),n&&r.push(n),a&&r.push(a),0===r.length)return;let i=e.latLngBounds(r.map(e=>[e.lat,e.lng]));c.current.fitBounds(i.pad(.25),{maxZoom:16})}return i.useEffect(()=>{let e=!1;return(async function(){return!!window.L||(await new Promise(e=>{let t=document.querySelector("link[data-leaflet]"),n=document.querySelector("script[data-leaflet]");if(!t){let e=document.createElement("link");e.rel="stylesheet",e.href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css",e.setAttribute("data-leaflet","1"),document.head.appendChild(e)}if(n){e();return}let r=document.createElement("script");r.src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js",r.async=!0,r.defer=!0,r.setAttribute("data-leaflet","1"),r.onload=()=>e(),r.onerror=()=>e(),document.body.appendChild(r)}),!!window.L)})().then(t=>{if(e||!t)return;let n=window.L;if(s.current){if(!c.current){let e=s.current,t=n.map(e,{zoomControl:!0});t.setView([0,0],2),n.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(t),c.current=t}u.current=!0,f(),h()}}),()=>{e=!0}},[]),i.useEffect(()=>{u.current&&(f(),h())},[JSON.stringify(t),JSON.stringify(n)]),i.useEffect(()=>{u.current&&f()},[JSON.stringify(a)]),(0,r.jsxs)("div",{style:{position:"relative",width:"100%",height:l},children:[(0,r.jsx)("div",{ref:s,style:{width:"100%",height:"100%"}}),o&&(0,r.jsxs)("div",{style:{position:"absolute",top:8,right:8,display:"flex",flexDirection:"column",gap:6},children:[(0,r.jsx)("button",{className:"btn secondary","aria-label":"Centrar a origen",onClick:()=>m(t),children:"Origen"}),(0,r.jsx)("button",{className:"btn secondary","aria-label":"Centrar a destino",onClick:()=>m(n),children:"Destino"}),(0,r.jsx)("button",{className:"btn secondary","aria-label":"Centrar a conductor",onClick:()=>m(a),children:"Driver"}),(0,r.jsx)("button",{className:"btn secondary","aria-label":"Encajar todo",onClick:()=>h(),children:"Reencuadrar"})]})]});function m(e){window.L&&c.current&&e&&isFinite(e.lat)&&isFinite(e.lng)&&c.current.setView([e.lat,e.lng],Math.max(14,c.current.getZoom()||14),{animate:!0})}}},8873:function(e,t,n){"use strict";n.d(t,{V:function(){return o},p:function(){return l}});var r=n(7437),i=n(2265);let a=(0,i.createContext)(null);function l(){let e=(0,i.useContext)(a);if(!e)throw Error("useToast must be used within ToastProvider");return e}function o(e){let{children:t}=e,[n,l]=(0,i.useState)([]),o=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3200,r=Date.now()+Math.floor(1e3*Math.random()),i={id:r,kind:t,text:e,ttl:Date.now()+n};l(e=>[...e,i]),setTimeout(()=>l(e=>e.filter(e=>e.id!==r)),n)},s=(0,i.useMemo)(()=>({show:o}),[]);return(0,r.jsxs)(a.Provider,{value:s,children:[t,(0,r.jsx)("div",{style:{position:"fixed",top:12,right:12,display:"flex",flexDirection:"column",gap:8,zIndex:1e3},children:n.map(e=>(0,r.jsxs)("div",{className:"card",style:{padding:"10px 12px",minWidth:260,maxWidth:360,borderLeft:"4px solid ".concat("success"===e.kind?"#22c55e":"error"===e.kind?"#ef4444":"#3b82f6")},children:[(0,r.jsx)("div",{style:{fontWeight:600,marginBottom:2},children:"success"===e.kind?"\xc9xito":"error"===e.kind?"Error":"Info"}),(0,r.jsx)("div",{className:"muted",children:e.text})]},e.id))})]})}},2800:function(e,t,n){"use strict";n.d(t,{S:function(){return r},j:function(){return i}});let r="http://localhost:8081";async function i(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2?arguments[2]:void 0,i=new Headers(t.headers||{});i.set("Content-Type","application/json"),n&&i.set("Authorization","Bearer ".concat(n));let a=await fetch("".concat(r).concat(e),{...t,headers:i,cache:"no-store"});if(!a.ok){let e=await a.text().catch(()=>"");throw Error("API ".concat(a.status,": ").concat(e||a.statusText))}return a.json()}},4282:function(e,t,n){"use strict";n.d(t,{DH:function(){return s},J1:function(){return l},PR:function(){return o},oC:function(){return c}});var r=n(6300).Buffer;let i="taxi_token",a="taxi_user";function l(e,t){localStorage.setItem(i,e),localStorage.setItem(a,JSON.stringify(t))}function o(){let e=localStorage.getItem(a);if(!e)return null;try{return JSON.parse(e)}catch(e){return null}}function s(){localStorage.removeItem(i),localStorage.removeItem(a)}function c(){let e=localStorage.getItem(i);return e?!function(e){let t=function(e){let t=e.split(".");if(3!==t.length)return null;try{let e=function(e){try{let t=e.length%4==2?"==":e.length%4==3?"=":e.length%4==1?"===":"",n=e.replace(/-/g,"+").replace(/_/g,"/")+t;if("function"==typeof atob)return atob(n);return r.from(n,"base64").toString("binary")}catch(e){return""}}(t[1]);return JSON.parse(e)}catch(e){return null}}(e);return null!=t&&!!t.exp&&Math.floor(Date.now()/1e3)>=t.exp}(e)?e:(s(),null):null}},5155:function(e,t,n){"use strict";async function r(e,t){let n=new AbortController,r=t.signal?function(e,t){if(e.aborted)return e;if(t.aborted)return t;let n=new AbortController,r=()=>n.abort();return e.addEventListener("abort",r),t.addEventListener("abort",r),n.signal}(n.signal,t.signal):n.signal,i=await fetch(e,{method:"GET",headers:{Accept:"text/event-stream",...t.token?{Authorization:"Bearer ".concat(t.token)}:{}},cache:"no-store",signal:r});if(!i.ok||!i.body)throw Error("SSE HTTP ".concat(i.status));let a=i.body.getReader(),l=new TextDecoder("utf-8"),o="",s=!1;return(async()=>{try{for(;;){let e;let{value:n,done:r}=await a.read();if(r)break;for(o+=l.decode(n,{stream:!0});-1!==(e=o.indexOf("\n\n"));){let n=o.slice(0,e);o=o.slice(e+2);let r=function(e){let t;let n=e.split(/\r?\n/),r=[];for(let e of n){if(!e||e.startsWith(":"))continue;let n=e.indexOf(":"),i=-1===n?e:e.slice(0,n),a=-1===n?"":e.slice(n+1).replace(/^ /,"");"event"===i?t=a:"data"===i&&r.push(a)}let i=r.join("\n"),a=i;try{a=i?JSON.parse(i):void 0}catch(e){}return t||i?{event:t,data:a}:null}(n);r&&t.onEvent(r)}}}catch(e){}finally{s||n.abort()}})(),{close:()=>{s=!0,n.abort()}}}n.d(t,{Z:function(){return r}})}},function(e){e.O(0,[300,971,23,744],function(){return e(e.s=6518)}),_N_E=e.O()}]);