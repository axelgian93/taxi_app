(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[782],{6941:function(e,t,n){Promise.resolve().then(n.bind(n,3346))},3346:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return i}});var a=n(7437),l=n(2265),r=n(4282),s=n(2800);function i(){let[e,t]=(0,l.useState)("Guayaquil"),[n,i]=(0,l.useState)(null),[o,u]=(0,l.useState)(null),[d,h]=(0,l.useState)("CASH"),[g,m]=(0,l.useState)(null),[f,p]=(0,l.useState)(!1),[x,y]=(0,l.useState)(null),[j,S]=(0,l.useState)(""),[v,N]=(0,l.useState)([]),[b,w]=(0,l.useState)("origin"),[C,k]=(0,l.useState)(null),[I,M]=(0,l.useState)(null);async function O(){if(n&&o){p(!0),y(null);try{let t=(0,r.oC)();if(!t){location.href="/rider/login";return}let a={city:e,pickupLat:n.lat,pickupLng:n.lng,dropoffLat:o.lat,dropoffLng:o.lng,distanceKm:(null==g?void 0:g.distanceKm)||3,durationMin:(null==g?void 0:g.durationMin)||10,preferredMethod:d},l=await (0,s.j)("/trips/request",{method:"POST",body:JSON.stringify(a)},t);location.href="/rider/trip/".concat(l.trip.id)}catch(e){y((null==e?void 0:e.message)||"Error al solicitar")}finally{p(!1)}}}return(0,l.useEffect)(()=>{(0,r.PR)()||(location.href="/rider/login")},[]),(0,l.useEffect)(()=>{try{let e=localStorage.getItem("rider_payment_method");("CASH"===e||"CARD"===e)&&h(e)}catch(e){}},[]),(0,l.useEffect)(()=>{try{localStorage.setItem("rider_payment_method",d)}catch(e){}},[d]),(0,l.useEffect)(()=>{if(!n||!o){m(null);return}let e=function(e,t,n,a){let l=Math.sin((n-e)*Math.PI/180/2)**2+Math.cos(e*Math.PI/180)*Math.cos(n*Math.PI/180)*Math.sin((a-t)*Math.PI/180/2)**2;return 2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l))*6371}(n.lat,n.lng,o.lat,o.lng),t=Math.max(5,Math.round(4*e)),a=1.5+.5*e+.2*t;m({distanceKm:Number(e.toFixed(2)),durationMin:t,priceUsd:Number(Math.max(2,a).toFixed(2))})},[JSON.stringify(n),JSON.stringify(o)]),(0,l.useEffect)(()=>{try{let e=localStorage.getItem("fav_home");e&&k(JSON.parse(e))}catch(e){}try{let e=localStorage.getItem("fav_work");e&&M(JSON.parse(e))}catch(e){}},[]),(0,l.useEffect)(()=>{let e=!1,t=j.trim();if(!t){N([]);return}let n=setTimeout(async()=>{try{let n="https://nominatim.openstreetmap.org/search?format=json&addressdetails=0&limit=5&q=".concat(encodeURIComponent(t)),a=await fetch(n,{headers:{"Accept-Language":"es"}});if(!a.ok)return;let l=await a.json();e||N(Array.isArray(l)?l:[])}catch(t){e||N([])}},400);return()=>{e=!0,clearTimeout(n)}},[j]),(0,a.jsxs)("div",{children:[(0,a.jsx)("h2",{children:"Solicitar viaje"}),(0,a.jsxs)("div",{className:"row",style:{gap:12,flexWrap:"wrap",alignItems:"center"},children:[(0,a.jsxs)("label",{children:[(0,a.jsx)("div",{className:"muted",children:"Ciudad"}),(0,a.jsx)("input",{value:e,onChange:e=>t(e.target.value),placeholder:"Guayaquil"})]}),(0,a.jsxs)("label",{className:"row",style:{gap:6,alignItems:"center"},children:[(0,a.jsx)("span",{children:"M\xe9todo"}),(0,a.jsxs)("select",{value:d,onChange:e=>h(e.target.value),children:[(0,a.jsx)("option",{value:"CASH",children:"CASH"}),(0,a.jsx)("option",{value:"CARD",children:"CARD"})]})]}),(0,a.jsx)("button",{className:"btn",onClick:O,disabled:!n||!o||f,children:f?"Solicitando…":"Solicitar"})]}),(0,a.jsxs)("div",{className:"card",style:{marginTop:10},children:[(0,a.jsxs)("div",{className:"row",style:{gap:8,flexWrap:"wrap"},children:[(0,a.jsxs)("label",{children:[(0,a.jsx)("div",{className:"muted",children:"Origen (click en mapa)"}),(0,a.jsx)("input",{readOnly:!0,value:n?"".concat(n.lat.toFixed(6),", ").concat(n.lng.toFixed(6)):""})]}),(0,a.jsxs)("div",{className:"row",style:{gap:8,alignItems:"center"},children:[(0,a.jsxs)("label",{className:"row",style:{gap:6,alignItems:"center"},children:[(0,a.jsx)("span",{children:"Buscar"}),(0,a.jsx)("input",{placeholder:"Direcci\xf3n, punto de inter\xe9s…",value:j,onChange:e=>S(e.target.value),style:{minWidth:260}})]}),(0,a.jsxs)("label",{className:"row",style:{gap:6,alignItems:"center"},children:[(0,a.jsx)("span",{children:"Aplicar a"}),(0,a.jsxs)("select",{value:b,onChange:e=>w(e.target.value),children:[(0,a.jsx)("option",{value:"origin",children:"Origen"}),(0,a.jsx)("option",{value:"dest",children:"Destino"})]})]}),v.length>0&&(0,a.jsx)("div",{className:"card",style:{padding:8},children:(0,a.jsx)("ul",{style:{listStyle:"none",padding:0,margin:0},children:v.map((e,t)=>(0,a.jsx)("li",{children:(0,a.jsx)("button",{className:"btn secondary",onClick:()=>{let t={lat:Number(e.lat),lng:Number(e.lon)};"origin"===b?i(t):u(t),N([]),S("")},children:e.display_name})},t))})})]}),(0,a.jsxs)("div",{className:"row",style:{gap:8,alignItems:"center"},children:[(0,a.jsx)("span",{className:"muted",children:"Favoritos:"}),(0,a.jsx)("button",{className:"btn secondary",onClick:()=>C&&("origin"===b?i(C):u(C)),disabled:!C,children:"Casa"}),(0,a.jsx)("button",{className:"btn secondary",onClick:()=>I&&("origin"===b?i(I):u(I)),disabled:!I,children:"Trabajo"}),(0,a.jsx)("button",{className:"btn secondary",onClick:()=>{let e="origin"===b?n:o;e&&(localStorage.setItem("fav_home",JSON.stringify(e)),k(e))},children:"Guardar Casa"}),(0,a.jsx)("button",{className:"btn secondary",onClick:()=>{let e="origin"===b?n:o;e&&(localStorage.setItem("fav_work",JSON.stringify(e)),M(e))},children:"Guardar Trabajo"})]}),(0,a.jsxs)("label",{children:[(0,a.jsx)("div",{className:"muted",children:"Destino (clic derecho/Alt)"}),(0,a.jsx)("input",{readOnly:!0,value:o?"".concat(o.lat.toFixed(6),", ").concat(o.lng.toFixed(6)):""})]}),g&&(0,a.jsxs)("div",{className:"row",style:{gap:12},children:[(0,a.jsxs)("span",{className:"muted",children:["Dist: ",g.distanceKm," km"]}),(0,a.jsxs)("span",{className:"muted",children:["Dur: ",g.durationMin," min"]}),(0,a.jsxs)("span",{children:["Estimado: ",(0,a.jsxs)("strong",{children:["$",g.priceUsd.toFixed(2)]})]}),(0,a.jsxs)("span",{className:"muted",children:["Pago: ",d]})]}),x&&(0,a.jsx)("div",{style:{color:"var(--danger)"},children:x})]}),(0,a.jsx)("div",{style:{height:360,marginTop:10},children:(0,a.jsx)(c,{onPick:i,onPickAlt:u})})]})]})}function c(e){let{onPick:t,onPickAlt:n}=e,r=(0,l.useRef)(null),s=(0,l.useRef)(null),i=(0,l.useRef)({});function c(e,t,n){let a=window.L,l=s.current;if(!a||!l)return;let r=i.current;r[e]?r[e].setLatLng([t.lat,t.lng]):r[e]=a.circleMarker([t.lat,t.lng],{radius:8,color:n,fillColor:n,fillOpacity:.6}).addTo(l)}return(0,l.useEffect)(()=>{let e=!1;return(async()=>{await new Promise(e=>{if(window.L)return e();let t=document.createElement("link");t.rel="stylesheet",t.href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css",document.head.appendChild(t);let n=document.createElement("script");n.src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js",n.async=!0,n.defer=!0,n.onload=()=>e(),n.onerror=()=>e(),document.body.appendChild(n)}),e||function(){let e=window.L;if(!e||!r.current)return;let a=e.map(r.current);a.setView([-2.170998,-79.922359],13),e.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(a),s.current=a,a.on("click",e=>{t({lat:e.latlng.lat,lng:e.latlng.lng}),c("o",e.latlng,"#22c55e")}),a.on("contextmenu",e=>{n({lat:e.latlng.lat,lng:e.latlng.lng}),c("d",e.latlng,"#ef4444")})}()})(),()=>{e=!0}},[]),(0,a.jsx)("div",{ref:r,style:{width:"100%",height:"100%"}})}},2800:function(e,t,n){"use strict";n.d(t,{S:function(){return a},j:function(){return l}});let a="http://localhost:8081";async function l(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2?arguments[2]:void 0,l=new Headers(t.headers||{});l.set("Content-Type","application/json"),n&&l.set("Authorization","Bearer ".concat(n));let r=await fetch("".concat(a).concat(e),{...t,headers:l,cache:"no-store"});if(!r.ok){let e=await r.text().catch(()=>"");throw Error("API ".concat(r.status,": ").concat(e||r.statusText))}return r.json()}},4282:function(e,t,n){"use strict";n.d(t,{DH:function(){return c},J1:function(){return s},PR:function(){return i},oC:function(){return o}});var a=n(6300).Buffer;let l="taxi_token",r="taxi_user";function s(e,t){localStorage.setItem(l,e),localStorage.setItem(r,JSON.stringify(t))}function i(){let e=localStorage.getItem(r);if(!e)return null;try{return JSON.parse(e)}catch(e){return null}}function c(){localStorage.removeItem(l),localStorage.removeItem(r)}function o(){let e=localStorage.getItem(l);return e?!function(e){let t=function(e){let t=e.split(".");if(3!==t.length)return null;try{let e=function(e){try{let t=e.length%4==2?"==":e.length%4==3?"=":e.length%4==1?"===":"",n=e.replace(/-/g,"+").replace(/_/g,"/")+t;if("function"==typeof atob)return atob(n);return a.from(n,"base64").toString("binary")}catch(e){return""}}(t[1]);return JSON.parse(e)}catch(e){return null}}(e);return null!=t&&!!t.exp&&Math.floor(Date.now()/1e3)>=t.exp}(e)?e:(c(),null):null}}},function(e){e.O(0,[300,971,23,744],function(){return e(e.s=6941)}),_N_E=e.O()}]);