(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[586],{1273:function(e,t,n){Promise.resolve().then(n.bind(n,5870))},6463:function(e,t,n){"use strict";var r=n(1169);n.o(r,"useParams")&&n.d(t,{useParams:function(){return r.useParams}}),n.o(r,"useRouter")&&n.d(t,{useRouter:function(){return r.useRouter}}),n.o(r,"useSearchParams")&&n.d(t,{useSearchParams:function(){return r.useSearchParams}})},5870:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return f}});var r=n(7437),a=n(2265),i=n(6463),l=n(4282),o=n(2800),c=n(2268),s=n(5155),u=n(8873),d=n(21);function f(){var e;let{show:t}=(0,u.p)(),n=(0,i.useParams)(),f=(null==n?void 0:n.id)||"",[m,y]=(0,a.useState)(null),[b,j]=(0,a.useState)(null),[N,S]=(0,a.useState)(null),[w,k]=(0,a.useState)(null),[C,E]=(0,a.useState)(null),L=(0,a.useRef)(null);if((0,a.useEffect)(()=>{(async()=>{try{let e=(0,l.oC)();if(!e){location.href="/rider/login";return}let t=await (0,o.j)("/trips/".concat(encodeURIComponent(f)),{},e);y(t.trip);try{p(f,E,L)}catch(e){}(0,s.Z)("".concat("http://localhost:8081","/trips/").concat(encodeURIComponent(f),"/sse"),{token:e,onEvent:e=>{var t,n,r,a;if(null==e?void 0:null===(t=e.data)||void 0===t?void 0:t.status){y(t=>t?{...t,status:e.data.status}:t);try{p(f,E,L)}catch(e){}"COMPLETED"===e.data.status&&h(f,S)}"LOCATION"===(e.event||(null==e?void 0:null===(n=e.data)||void 0===n?void 0:n.type))&&(null==e?void 0:null===(r=e.data)||void 0===r?void 0:r.lat)!=null&&(null==e?void 0:null===(a=e.data)||void 0===a?void 0:a.lng)!=null&&j({lat:Number(e.data.lat),lng:Number(e.data.lng)})}}).catch(()=>{})}catch(e){k((null==e?void 0:e.message)||"Error")}})()},[f]),!f)return(0,r.jsx)("div",{children:"Sin id"});if(w)return(0,r.jsx)("div",{style:{color:"var(--danger)"},children:w});if(!m)return(0,r.jsxs)("div",{children:[(0,r.jsx)("h2",{children:"Mi viaje"}),(0,r.jsx)(d.ik,{lines:2}),(0,r.jsx)("div",{style:{marginTop:10},children:(0,r.jsx)(d.qM,{height:360})}),(0,r.jsxs)("div",{className:"row",style:{gap:8,marginTop:10},children:[(0,r.jsx)(d.qM,{height:32,width:140}),(0,r.jsx)(d.qM,{height:32,width:120})]})]});let R=m.pickupLat&&m.pickupLng?{lat:Number(m.pickupLat),lng:Number(m.pickupLng)}:null,T=m.dropoffLat&&m.dropoffLng?{lat:Number(m.dropoffLat),lng:Number(m.dropoffLng)}:null,M=b&&null!=b.lat&&null!=b.lng?{lat:Number(b.lat),lng:Number(b.lng)}:void 0;return(0,r.jsxs)("div",{children:[(0,r.jsx)("h2",{children:"Mi viaje"}),(0,r.jsxs)("div",{className:"muted",children:["ID: ",m.id]}),(0,r.jsxs)("div",{className:"muted",children:["Estado: ",m.status]}),(0,r.jsx)(x,{status:m.status}),C&&(0,r.jsx)("div",{className:"row",style:{gap:8,alignItems:"center",marginTop:6},children:"number"==typeof C.graceRemainingSec&&C.graceRemainingSec>0?(0,r.jsxs)("div",{className:"card",style:{padding:"4px 8px"},children:["Ventana de gracia: ",(e=C.graceRemainingSec,"".concat(String(Math.floor(e/60)).padStart(2,"0"),":").concat(String(e%60).padStart(2,"0")))]}):(0,r.jsx)("div",{className:"muted",children:C.feeUsd>0?"Tarifa de cancelaci\xf3n estimada: $".concat(C.feeUsd.toFixed(2)):"Cancelaci\xf3n sin tarifa"})}),(0,r.jsx)(v,{trip:m,driverLoc:b}),(0,r.jsx)("div",{style:{marginTop:10},children:(0,r.jsx)(c.Z,{origin:R,destination:T,driver:M,height:360,controls:!0})}),(0,r.jsxs)("div",{style:{marginTop:10},children:["STARTED"!==m.status&&"COMPLETED"!==m.status&&"CANCELED"!==m.status&&(0,r.jsx)("button",{className:"btn danger","aria-label":"Cancelar viaje",onClick:()=>g(m,f,t,y),children:"Cancelar viaje"}),(0,r.jsx)("button",{className:"btn secondary","aria-label":"Ver recibo",onClick:async()=>{await h(f,S),N||t("Recibo cargado","success")},style:{marginLeft:8},children:"Ver recibo"}),N&&(0,r.jsxs)("div",{className:"card",style:{marginTop:8},children:[(0,r.jsxs)("div",{className:"muted",children:["Monto: $",Number(N.amountUsd||0).toFixed(2)," ",N.currency||"USD"]}),(0,r.jsxs)("div",{className:"muted",children:["Pago: ",N.status||"-"," ",N.method?"• ".concat(N.method):""]}),(0,r.jsxs)("div",{className:"muted",children:["Fecha: ",new Date(N.createdAt).toLocaleString()]})]})]})]})}async function h(e,t){try{let n=(0,l.oC)();if(!n)return;let r=await fetch("".concat("http://localhost:8081","/payments/").concat(encodeURIComponent(e),"/receipt"),{headers:{Authorization:"Bearer ".concat(n)},cache:"no-store"});if(!r.ok)return;let a=await r.json();t(a)}catch(e){}}async function g(e,t,n,r){try{let e=(0,l.oC)();if(!e)return;let a=await fetch("".concat("http://localhost:8081","/rider/trips/").concat(encodeURIComponent(t),"/cancel/quote"),{headers:{Authorization:"Bearer ".concat(e)},cache:"no-store"}),i="\xbfCancelar el viaje?";if(a.ok){let e=await a.json();e&&e.cancellable?e.feeUsd&&e.feeUsd>0?i="Se aplicar\xe1 una tarifa de cancelaci\xf3n de $".concat(Number(e.feeUsd).toFixed(2),". \xbfDeseas cancelar?"):"number"==typeof e.graceRemainingSec&&e.graceRemainingSec>0&&(i="A\xfan dentro de la ventana de gracia (".concat(e.graceRemainingSec,"s). No se cobrar\xe1 tarifa. \xbfCancelar?")):i="Este viaje ya no puede cancelarse."}if(!confirm(i))return;m(t,n,r)}catch(e){if(!confirm("\xbfCancelar el viaje?"))return;m(t,n,r)}}async function m(e,t,n){try{let r=(0,l.oC)();if(!r)return;let a=await fetch("".concat("http://localhost:8081","/trips/").concat(encodeURIComponent(e),"/cancel"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(r)},body:JSON.stringify({reason:"DEMO"})});if(!a.ok){t("No se pudo cancelar","error");return}let i=await a.json();n(e=>{var t;return e?{...e,status:(null==i?void 0:null===(t=i.trip)||void 0===t?void 0:t.status)||"CANCELED"}:e}),t("Viaje cancelado","success")}catch(e){t("No se pudo cancelar","error")}}async function p(e,t,n){let r=(0,l.oC)();if(r)try{let a=await fetch("".concat("http://localhost:8081","/rider/trips/").concat(encodeURIComponent(e),"/cancel/quote"),{headers:{Authorization:"Bearer ".concat(r)},cache:"no-store"});if(!a.ok)return;let i=await a.json();t({feeUsd:Number(i.feeUsd||0),graceRemainingSec:"number"==typeof i.graceRemainingSec?i.graceRemainingSec:null,cancellable:!!i.cancellable}),n.current&&(clearInterval(n.current),n.current=null),"number"==typeof i.graceRemainingSec&&i.graceRemainingSec>0&&(n.current=setInterval(()=>{t(e=>{if(!e)return e;let t=Math.max(0,Number(e.graceRemainingSec||0)-1);return{...e,graceRemainingSec:t}})},1e3))}catch(e){}}function v(e){let{trip:t,driverLoc:n}=e,a=(e,t)=>{if(!e||!t||null==e.lat||null==e.lng||null==t.lat||null==t.lng)return null;let n=i(t.lat-e.lat),r=i(t.lng-e.lng),a=Math.sin(n/2)**2+Math.cos(i(e.lat))*Math.cos(i(t.lat))*Math.sin(r/2)**2;return 2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))*6371},i=e=>e*Math.PI/180,l=t.pickupLat&&t.pickupLng?{lat:Number(t.pickupLat),lng:Number(t.pickupLng)}:null,o=t.dropoffLat&&t.dropoffLng?{lat:Number(t.dropoffLat),lng:Number(t.dropoffLng)}:null,c=n&&l?a(n,l):null,s=l&&o?a(l,o):null,u=e=>null==e?null:Math.round(e/28*60);return(0,r.jsxs)("div",{className:"muted",style:{marginTop:6},children:[null!=c&&(0,r.jsxs)("span",{children:["Distancia a recogida: ",c.toFixed(2)," km • ETA ~",u(c)," min. "]}),null!=s&&(0,r.jsxs)("span",{children:["Trayecto estimado: ",s.toFixed(2)," km • ~",u(s)," min."]})]})}function x(e){let{status:t}=e,n=["REQUESTED","ASSIGNED","ACCEPTED","ARRIVED","STARTED","COMPLETED"],a=n.indexOf(t);return(0,r.jsxs)("div",{className:"row",style:{gap:6,marginTop:6,flexWrap:"wrap",alignItems:"center"},children:[n.map((e,t)=>(0,r.jsxs)("div",{style:{display:"flex",alignItems:"center"},children:[(0,r.jsx)("div",{className:"card",style:{padding:"4px 8px",background:t<=a?"var(--brand-weak)":void 0},children:e}),t<n.length-1&&(0,r.jsx)("span",{style:{margin:"0 4px"},children:"›"})]},e)),"CANCELED"===t&&(0,r.jsx)("div",{className:"card",style:{padding:"4px 8px",background:"var(--danger-weak)",color:"var(--danger)"},children:"CANCELED"})]})}},2268:function(e,t,n){"use strict";n.d(t,{Z:function(){return i}});var r=n(7437),a=n(2265);function i(e){let{origin:t,destination:n,driver:i,height:l=320,controls:o=!1}=e,c=a.useRef(null),s=a.useRef(null),u=a.useRef({}),d=a.useRef(!1);function f(){let e=window.L;if(!e||!s.current)return;let r=s.current,a=u.current,l=(t,n)=>e.circleMarker([t.lat,t.lng],{radius:8,color:n,weight:2,fillColor:n,fillOpacity:.6});t&&isFinite(t.lat)&&isFinite(t.lng)?a.origin?a.origin.setLatLng([t.lat,t.lng]):a.origin=l(t,"#22c55e").addTo(r):a.origin&&(r.removeLayer(a.origin),a.origin=void 0),n&&isFinite(n.lat)&&isFinite(n.lng)?a.destination?a.destination.setLatLng([n.lat,n.lng]):a.destination=l(n,"#ef4444").addTo(r):a.destination&&(r.removeLayer(a.destination),a.destination=void 0),i&&isFinite(i.lat)&&isFinite(i.lng)?a.driver?a.driver.setLatLng([i.lat,i.lng]):a.driver=l(i,"#4f46e5").addTo(r):a.driver&&(r.removeLayer(a.driver),a.driver=void 0)}function h(){let e=window.L;if(!e||!s.current)return;let r=[];if(t&&r.push(t),n&&r.push(n),i&&r.push(i),0===r.length)return;let a=e.latLngBounds(r.map(e=>[e.lat,e.lng]));s.current.fitBounds(a.pad(.25),{maxZoom:16})}return a.useEffect(()=>{let e=!1;return(async function(){return!!window.L||(await new Promise(e=>{let t=document.querySelector("link[data-leaflet]"),n=document.querySelector("script[data-leaflet]");if(!t){let e=document.createElement("link");e.rel="stylesheet",e.href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css",e.setAttribute("data-leaflet","1"),document.head.appendChild(e)}if(n){e();return}let r=document.createElement("script");r.src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js",r.async=!0,r.defer=!0,r.setAttribute("data-leaflet","1"),r.onload=()=>e(),r.onerror=()=>e(),document.body.appendChild(r)}),!!window.L)})().then(t=>{if(e||!t)return;let n=window.L;if(c.current){if(!s.current){let e=c.current,t=n.map(e,{zoomControl:!0});t.setView([0,0],2),n.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(t),s.current=t}d.current=!0,f(),h()}}),()=>{e=!0}},[]),a.useEffect(()=>{d.current&&(f(),h())},[JSON.stringify(t),JSON.stringify(n)]),a.useEffect(()=>{d.current&&f()},[JSON.stringify(i)]),(0,r.jsxs)("div",{style:{position:"relative",width:"100%",height:l},children:[(0,r.jsx)("div",{ref:c,style:{width:"100%",height:"100%"}}),o&&(0,r.jsxs)("div",{style:{position:"absolute",top:8,right:8,display:"flex",flexDirection:"column",gap:6},children:[(0,r.jsx)("button",{className:"btn secondary","aria-label":"Centrar a origen",onClick:()=>g(t),children:"Origen"}),(0,r.jsx)("button",{className:"btn secondary","aria-label":"Centrar a destino",onClick:()=>g(n),children:"Destino"}),(0,r.jsx)("button",{className:"btn secondary","aria-label":"Centrar a conductor",onClick:()=>g(i),children:"Driver"}),(0,r.jsx)("button",{className:"btn secondary","aria-label":"Encajar todo",onClick:()=>h(),children:"Reencuadrar"})]})]});function g(e){window.L&&s.current&&e&&isFinite(e.lat)&&isFinite(e.lng)&&s.current.setView([e.lat,e.lng],Math.max(14,s.current.getZoom()||14),{animate:!0})}}},21:function(e,t,n){"use strict";n.d(t,{ik:function(){return i},qM:function(){return a}});var r=n(7437);function a(e){let{height:t=16,width:n="100%",style:a,className:i}=e;return(0,r.jsx)("div",{className:i,style:{height:t,width:n,background:"linear-gradient(90deg, rgba(255,255,255,0.06) 25%, rgba(255,255,255,0.12) 37%, rgba(255,255,255,0.06) 63%)",backgroundSize:"400% 100%",animation:"skeleton 1.2s ease-in-out infinite",borderRadius:8,...a}})}function i(e){let{lines:t=3}=e;return(0,r.jsx)("div",{className:"row",style:{gap:8,flexDirection:"column"},children:Array.from({length:t}).map((e,t)=>(0,r.jsx)(a,{height:12,width:"".concat(80-8*t,"%")},t))})}if(n(2265),!document.getElementById("sk-keyframes")){let e=document.createElement("style");e.id="sk-keyframes",e.innerHTML="@keyframes skeleton { 0%{background-position:100% 50%} 100%{background-position:0 50%} }",document.head.appendChild(e)}},8873:function(e,t,n){"use strict";n.d(t,{V:function(){return o},p:function(){return l}});var r=n(7437),a=n(2265);let i=(0,a.createContext)(null);function l(){let e=(0,a.useContext)(i);if(!e)throw Error("useToast must be used within ToastProvider");return e}function o(e){let{children:t}=e,[n,l]=(0,a.useState)([]),o=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3200,r=Date.now()+Math.floor(1e3*Math.random()),a={id:r,kind:t,text:e,ttl:Date.now()+n};l(e=>[...e,a]),setTimeout(()=>l(e=>e.filter(e=>e.id!==r)),n)},c=(0,a.useMemo)(()=>({show:o}),[]);return(0,r.jsxs)(i.Provider,{value:c,children:[t,(0,r.jsx)("div",{style:{position:"fixed",top:12,right:12,display:"flex",flexDirection:"column",gap:8,zIndex:1e3},children:n.map(e=>(0,r.jsxs)("div",{className:"card",style:{padding:"10px 12px",minWidth:260,maxWidth:360,borderLeft:"4px solid ".concat("success"===e.kind?"#22c55e":"error"===e.kind?"#ef4444":"#3b82f6")},children:[(0,r.jsx)("div",{style:{fontWeight:600,marginBottom:2},children:"success"===e.kind?"\xc9xito":"error"===e.kind?"Error":"Info"}),(0,r.jsx)("div",{className:"muted",children:e.text})]},e.id))})]})}},2800:function(e,t,n){"use strict";n.d(t,{S:function(){return r},j:function(){return a}});let r="http://localhost:8081";async function a(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2?arguments[2]:void 0,a=new Headers(t.headers||{});a.set("Content-Type","application/json"),n&&a.set("Authorization","Bearer ".concat(n));let i=await fetch("".concat(r).concat(e),{...t,headers:a,cache:"no-store"});if(!i.ok){let e=await i.text().catch(()=>"");throw Error("API ".concat(i.status,": ").concat(e||i.statusText))}return i.json()}},4282:function(e,t,n){"use strict";n.d(t,{DH:function(){return c},J1:function(){return l},PR:function(){return o},oC:function(){return s}});var r=n(6300).Buffer;let a="taxi_token",i="taxi_user";function l(e,t){localStorage.setItem(a,e),localStorage.setItem(i,JSON.stringify(t))}function o(){let e=localStorage.getItem(i);if(!e)return null;try{return JSON.parse(e)}catch(e){return null}}function c(){localStorage.removeItem(a),localStorage.removeItem(i)}function s(){let e=localStorage.getItem(a);return e?!function(e){let t=function(e){let t=e.split(".");if(3!==t.length)return null;try{let e=function(e){try{let t=e.length%4==2?"==":e.length%4==3?"=":e.length%4==1?"===":"",n=e.replace(/-/g,"+").replace(/_/g,"/")+t;if("function"==typeof atob)return atob(n);return r.from(n,"base64").toString("binary")}catch(e){return""}}(t[1]);return JSON.parse(e)}catch(e){return null}}(e);return null!=t&&!!t.exp&&Math.floor(Date.now()/1e3)>=t.exp}(e)?e:(c(),null):null}},5155:function(e,t,n){"use strict";async function r(e,t){let n=new AbortController,r=t.signal?function(e,t){if(e.aborted)return e;if(t.aborted)return t;let n=new AbortController,r=()=>n.abort();return e.addEventListener("abort",r),t.addEventListener("abort",r),n.signal}(n.signal,t.signal):n.signal,a=await fetch(e,{method:"GET",headers:{Accept:"text/event-stream",...t.token?{Authorization:"Bearer ".concat(t.token)}:{}},cache:"no-store",signal:r});if(!a.ok||!a.body)throw Error("SSE HTTP ".concat(a.status));let i=a.body.getReader(),l=new TextDecoder("utf-8"),o="",c=!1;return(async()=>{try{for(;;){let e;let{value:n,done:r}=await i.read();if(r)break;for(o+=l.decode(n,{stream:!0});-1!==(e=o.indexOf("\n\n"));){let n=o.slice(0,e);o=o.slice(e+2);let r=function(e){let t;let n=e.split(/\r?\n/),r=[];for(let e of n){if(!e||e.startsWith(":"))continue;let n=e.indexOf(":"),a=-1===n?e:e.slice(0,n),i=-1===n?"":e.slice(n+1).replace(/^ /,"");"event"===a?t=i:"data"===a&&r.push(i)}let a=r.join("\n"),i=a;try{i=a?JSON.parse(a):void 0}catch(e){}return t||a?{event:t,data:i}:null}(n);r&&t.onEvent(r)}}}catch(e){}finally{c||n.abort()}})(),{close:()=>{c=!0,n.abort()}}}n.d(t,{Z:function(){return r}})}},function(e){e.O(0,[300,971,23,744],function(){return e(e.s=1273)}),_N_E=e.O()}]);