(()=>{var e={};e.id=933,e.ids=[933],e.modules={2934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},4965:(e,t,n)=>{"use strict";n.r(t),n.d(t,{GlobalError:()=>i.a,__next_app__:()=>h,originalPathname:()=>u,pages:()=>d,routeModule:()=>p,tree:()=>o});var a=n(3191),r=n(8716),s=n(7922),i=n.n(s),l=n(5231),c={};for(let e in l)0>["default","tree","pages","GlobalError","originalPathname","__next_app__","routeModule"].indexOf(e)&&(c[e]=()=>l[e]);n.d(t,c);let o=["",{children:["driver",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(n.bind(n,2305)),"/app/src/app/driver/page.tsx"]}]},{}]},{layout:[()=>Promise.resolve().then(n.bind(n,2029)),"/app/src/app/layout.tsx"],"not-found":[()=>Promise.resolve().then(n.t.bind(n,5866,23)),"next/dist/client/components/not-found-error"]}],d=["/app/src/app/driver/page.tsx"],u="/driver/page",h={require:n,loadChunk:()=>Promise.resolve()},p=new a.AppPageRouteModule({definition:{kind:r.x.APP_PAGE,page:"/driver/page",pathname:"/driver",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:o}})},7296:(e,t,n)=>{Promise.resolve().then(n.bind(n,7579))},7579:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>d});var a=n(326),r=n(7577),s=n(6836),i=n(8069),l=n(6208),c=n(8145),o=n(2326);function d(){var e;let{show:t}=(0,c.p)(),[n,d]=(0,r.useState)(!0),[g,x]=(0,r.useState)(!1),[j,f]=(0,r.useState)(!0),[b,y]=(0,r.useState)(null),[v,N]=(0,r.useState)([]),[S,k]=(0,r.useState)(null),M=(0,r.useMemo)(()=>v.find(e=>e.id===S)||null,[v,S]),[C,w]=(0,r.useState)("CASH"),[R,A]=(0,r.useState)(null),I=(0,r.useRef)(null);(0,r.useRef)(null);let[T,P]=(0,r.useState)(!0),[L,E]=(0,r.useState)(null),[$,q]=(0,r.useState)(null),F=(0,r.useRef)(null);(0,r.useRef)(null);let O=(0,r.useRef)(new Set),_=(0,r.useRef)(null),[D,U]=(0,r.useState)(0),[G,z]=(0,r.useState)(!0),[B,H]=(0,r.useState)(!0);async function V(){P(!0);try{let e=(0,l.oC)();if(!e){location.replace("/login");return}let t=await (0,i.j)("/drivers/my-trips/active",{},e),n=Array.isArray(t.items)?t.items:[],a=n.filter(e=>"ASSIGNED"===e.status),r=n.find(e=>"ASSIGNED"!==e.status)||null,s=new Set(a.map(e=>e.id)),c=!1;for(let e of s)if(!O.current.has(e)){c=!0;break}if(O.current=s,N(a),y(r),r?.preferredMethod&&w(r.preferredMethod||C),r&&j&&!g)try{K()}catch{}if(c&&(function(){try{if(!G)return;let e=window.AudioContext||window.webkitAudioContext;if(!e)return;_.current||(_.current=new e);let t=_.current,n=t.createOscillator(),a=t.createGain();n.type="sine",n.frequency.value=880,a.gain.value=.05,n.connect(a),a.connect(t.destination),n.start(),setTimeout(()=>{try{n.stop(),n.disconnect(),a.disconnect()}catch{}},220)}catch{}}(),B)){let e=Date.now()+1200;U(e),setTimeout(()=>{U(0)},1250)}if(r)try{Z(r.id)}catch{}}catch(e){E(e?.message||"Error")}finally{P(!1)}}async function J(e){try{let n=(0,l.oC)();if(!n)return;await (0,i.j)("/drivers/status",{method:"POST",body:JSON.stringify({status:e})},n),d("OFFLINE"!==e),t("OFFLINE"===e?"Pasaste a OFFLINE":"Est\xe1s ONLINE","success")}catch(e){t(e?.message||"Error al actualizar estado","error")}}function K(){if(!navigator.geolocation){t("Geolocalizaci\xf3n no disponible","error");return}null==F.current&&(F.current=navigator.geolocation.watchPosition(e=>{let{latitude:t,longitude:n}=e.coords;q({lat:t,lng:n}),W(t,n).catch(()=>{})},e=>{t(e?.message||"No se pudo leer ubicaci\xf3n","error")},{enableHighAccuracy:!0,maximumAge:1e3,timeout:1e4}),x(!0),t("Compartiendo ubicaci\xf3n…","info"))}async function W(e,t){try{let a=(0,l.oC)();if(!a)return;let r=b?"ON_TRIP":n?"IDLE":"OFFLINE";await (0,i.j)("/drivers/location",{method:"POST",body:JSON.stringify({lat:e,lng:t,status:r})},a)}catch{}}async function Z(e){try{let t=await p(e);A(t),I.current&&(clearInterval(I.current),I.current=null),"number"==typeof t.graceRemainingSec&&t.graceRemainingSec>0&&(I.current=setInterval(()=>{A(e=>e?{...e,graceRemainingSec:Math.max(0,(e.graceRemainingSec||0)-1)}:e)},1e3))}catch{}}async function X(e,n){try{let a=(0,l.oC)();if(!a)return;if("start"===n?await (0,i.j)(`/trips/${encodeURIComponent(e)}/start`,{method:"POST",body:JSON.stringify({method:C||b?.preferredMethod||"CASH"})},a):"reject"===n?await (0,i.j)(`/trips/${encodeURIComponent(e)}/reject`,{method:"POST"},a):await (0,i.j)(`/trips/${encodeURIComponent(e)}/${n}`,{method:"POST"},a),t(`Acci\xf3n: ${n}`,"success"),"accept"===n&&j&&!g)try{K()}catch{}try{Z(e)}catch{}await V()}catch(e){t(e?.message||"Error realizando acci\xf3n","error")}}let Q=(0,r.useMemo)(()=>b?{lat:Number(b.pickupLat),lng:Number(b.pickupLng)}:null,[b?.id]),Y=(0,r.useMemo)(()=>b?{lat:Number(b.dropoffLat),lng:Number(b.dropoffLng)}:null,[b?.id]),[ee,et,en,ea]=(0,r.useMemo)(()=>{let e=(e,n)=>{if(!e||!n)return null;let a=t(n.lat-e.lat),r=t(n.lng-e.lng),s=Math.sin(a/2)**2+Math.cos(t(e.lat))*Math.cos(t(n.lat))*Math.sin(r/2)**2;return 2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s))*6371},t=e=>e*Math.PI/180,n=$&&Q?e($,Q):null,a=Q&&Y?e(Q,Y):null;return[n,null==n?null:Math.round(n/28*60),a,null==a?null:Math.round(a/28*60)]},[$,Q,Y]);return(0,a.jsxs)("div",{children:[a.jsx("h2",{children:"Panel del Conductor"}),L&&a.jsx("div",{style:{color:"var(--danger)",marginBottom:8},children:L}),a.jsx("div",{className:"card",style:{marginBottom:12},children:(0,a.jsxs)("div",{className:"row",style:{gap:10,flexWrap:"wrap",alignItems:"center"},children:[(0,a.jsxs)("label",{className:"row",style:{gap:6,alignItems:"center"},children:[a.jsx("input",{type:"checkbox",checked:n,onChange:e=>J(e.target.checked?"IDLE":"OFFLINE")}),a.jsx("span",{children:n?"Online":"Offline"})]}),(0,a.jsxs)("label",{className:"row",style:{gap:6,alignItems:"center"},children:[a.jsx("input",{type:"checkbox",checked:g,onChange:e=>e.target.checked?K():function(){if(null!=F.current){try{navigator.geolocation.clearWatch(F.current)}catch{}F.current=null}x(!1),t("Ubicaci\xf3n detenida","info")}()}),a.jsx("span",{children:"Compartir ubicaci\xf3n"})]}),a.jsx("a",{className:"btn secondary",href:"/driver/history",children:"Historial"}),a.jsx("button",{className:"btn secondary",onClick:V,disabled:T,children:"Refrescar"}),(0,a.jsxs)("label",{className:"row",style:{gap:6,alignItems:"center",marginLeft:8},children:[a.jsx("input",{type:"checkbox",checked:j,onChange:e=>f(e.target.checked)}),a.jsx("span",{children:"Auto compartir al aceptar"})]}),(0,a.jsxs)("label",{className:"row",style:{gap:6,alignItems:"center"},children:[a.jsx("input",{type:"checkbox",checked:G,onChange:e=>z(e.target.checked)}),a.jsx("span",{children:"Beep nuevos asignados"})]}),(0,a.jsxs)("label",{className:"row",style:{gap:6,alignItems:"center"},children:[a.jsx("input",{type:"checkbox",checked:B,onChange:e=>H(e.target.checked)}),a.jsx("span",{children:"Flash destacados"})]}),!g&&a.jsx("button",{className:"btn secondary",onClick:function(){if(!navigator.geolocation){t("Geolocalizaci\xf3n no disponible","error");return}navigator.geolocation.getCurrentPosition(e=>{let{latitude:n,longitude:a}=e.coords;q({lat:n,lng:a}),t("Ubicaci\xf3n capturada","success")},()=>t("No se pudo capturar ubicaci\xf3n","error"),{enableHighAccuracy:!0,maximumAge:1e3,timeout:8e3})},children:"Usar mi ubicaci\xf3n"})]})}),T&&(0,a.jsxs)("div",{className:"card",style:{marginBottom:12},children:[a.jsx("strong",{children:"Asignados"}),(0,a.jsxs)("div",{style:{marginTop:8},children:[a.jsx(o.qM,{height:14,width:220,style:{marginBottom:8}}),a.jsx(o.qM,{height:10,style:{marginBottom:6}}),a.jsx(o.qM,{height:10,style:{marginBottom:6}}),a.jsx(o.qM,{height:10,style:{marginBottom:6}})]})]}),v.length>0&&!T&&(0,a.jsxs)("div",{className:"card",style:{marginBottom:12,boxShadow:D&&D>Date.now()?"0 0 0 3px rgba(34,197,94,0.35) inset":void 0},children:[a.jsx("strong",{children:"Asignados"}),a.jsx("div",{className:"table-wrap",style:{marginTop:8},children:(0,a.jsxs)("table",{children:[a.jsx("thead",{children:(0,a.jsxs)("tr",{children:[a.jsx("th",{children:"ID"}),a.jsx("th",{children:"Recogida"}),a.jsx("th",{children:"Destino"}),a.jsx("th",{children:"Distancia"}),a.jsx("th",{children:"Acciones"})]})}),a.jsx("tbody",{children:(function(e,t){let n=e=>e*Math.PI/180,a=(e,t)=>{if(!e||!t)return null;let a=n(t.lat-e.lat),r=n(t.lng-e.lng),s=Math.sin(a/2)**2+Math.cos(n(e.lat))*Math.cos(n(t.lat))*Math.sin(r/2)**2;return 2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s))*6371},r=t.map(t=>{let n=e?a(e,{lat:Number(t.pickupLat),lng:Number(t.pickupLng)}):null;return{it:t,distKm:null==n?null:Number(n)}});return e?r.sort((e,t)=>(e.distKm??1/0)-(t.distKm??1/0)):r})($,v).map(({it:e,distKm:t})=>(0,a.jsxs)("tr",{children:[a.jsx("td",{children:e.id}),(0,a.jsxs)("td",{children:[e.pickupLat.toFixed(5),", ",e.pickupLng.toFixed(5)]}),(0,a.jsxs)("td",{children:[e.dropoffLat.toFixed(5),", ",e.dropoffLng.toFixed(5)]}),a.jsx("td",{children:null!=t?`${t.toFixed(2)} km`:"-"}),(0,a.jsxs)("td",{children:[a.jsx("button",{className:"btn secondary",onClick:()=>k(e.id),style:{marginRight:6},children:"Ver"}),a.jsx("button",{className:"btn",disabled:!n,onClick:()=>X(e.id,"accept"),style:{marginRight:6},children:"Aceptar"}),a.jsx("button",{className:"btn danger",onClick:()=>X(e.id,"reject"),children:"Rechazar"})]})]},e.id))})]})}),$&&a.jsx("div",{className:"muted",style:{marginTop:6},children:"Ordenado por cercan\xeda a tu ubicaci\xf3n"}),(0,a.jsxs)("div",{className:"card",style:{marginTop:10},children:[a.jsx("strong",{children:"Vista previa"}),M?(0,a.jsxs)("div",{style:{marginTop:8},children:[a.jsx(s.Z,{origin:{lat:Number(M.pickupLat),lng:Number(M.pickupLng)},destination:{lat:Number(M.dropoffLat),lng:Number(M.dropoffLng)},height:220}),a.jsx(m,{selected:M,driverLoc:$}),(0,a.jsxs)("div",{className:"row",style:{marginTop:8,gap:8},children:[a.jsx("button",{className:"btn secondary",onClick:()=>k(null),children:"Cerrar"}),a.jsx("button",{className:"btn",disabled:!n,onClick:()=>X(M.id,"accept"),children:"Aceptar"}),a.jsx("button",{className:"btn danger",onClick:()=>X(M.id,"reject"),children:"Rechazar"})]})]}):a.jsx("div",{className:"muted",style:{marginTop:8},children:"Selecciona un asignado para previsualizar"})]})]}),(0,a.jsxs)("div",{className:"card",children:[a.jsx("strong",{children:"Viaje activo"}),T?(0,a.jsxs)("div",{style:{marginTop:8},children:[a.jsx(o.ik,{lines:2}),a.jsx("div",{style:{marginTop:10},children:a.jsx(o.qM,{height:300})}),(0,a.jsxs)("div",{className:"row",style:{gap:8,marginTop:10},children:[a.jsx(o.qM,{height:32,width:120}),a.jsx(o.qM,{height:32,width:120}),a.jsx(o.qM,{height:32,width:120})]})]}):b?(0,a.jsxs)("div",{style:{marginTop:8},children:[(0,a.jsxs)("div",{className:"muted",children:["ID: ",b.id," • Estado: ",b.status," ",b.preferredMethod?`• Pago: ${b.preferredMethod}`:""]}),R&&a.jsx("div",{className:"row",style:{gap:8,alignItems:"center",marginTop:6},children:"number"==typeof R.graceRemainingSec&&R.graceRemainingSec>0?(0,a.jsxs)("div",{className:"card",style:{padding:"4px 8px"},children:["Gracia rider: ",(e=R.graceRemainingSec,`${String(Math.floor(e/60)).padStart(2,"0")}:${String(e%60).padStart(2,"0")}`)]}):a.jsx("div",{className:"muted",children:R.feeUsd>0?`Fee cancelaci\xf3n: $${R.feeUsd.toFixed(2)}`:"Sin fee por cancelaci\xf3n"})}),(0,a.jsxs)("div",{className:"muted",style:{marginTop:4},children:[null!=ee&&(0,a.jsxs)("span",{children:["Hacia recogida: ",ee.toFixed(2)," km • ~",et," min. "]}),null!=en&&(0,a.jsxs)("span",{children:["Trayecto: ",en.toFixed(2)," km • ~",ea," min."]})]}),a.jsx("div",{style:{marginTop:10},children:a.jsx(s.Z,{origin:Q,destination:Y,driver:$||void 0,height:300,controls:!0})}),(0,a.jsxs)("div",{className:"row",style:{gap:8,flexWrap:"wrap",marginTop:10},children:[(0,a.jsxs)("label",{className:"row",style:{gap:6,alignItems:"center"},children:[a.jsx("span",{children:"M\xe9todo"}),(0,a.jsxs)("select",{value:C,onChange:e=>w(e.target.value),children:[a.jsx("option",{value:"CASH",children:"CASH"}),a.jsx("option",{value:"CARD",children:"CARD"})]})]}),a.jsx("a",{className:"btn secondary",href:u(Q),target:"_blank",rel:"noopener noreferrer",children:"Google Maps (recogida)"}),a.jsx("a",{className:"btn secondary",href:u(Y),target:"_blank",rel:"noopener noreferrer",children:"Google Maps (destino)"}),a.jsx("a",{className:"btn secondary",href:h(Q),target:"_blank",rel:"noopener noreferrer",children:"Apple Maps (recogida)"}),a.jsx("a",{className:"btn secondary",href:h(Y),target:"_blank",rel:"noopener noreferrer",children:"Apple Maps (destino)"}),a.jsx("button",{className:"btn",disabled:"ASSIGNED"!==b.status||!n,onClick:()=>X(b.id,"accept"),children:"Aceptar"}),a.jsx("button",{className:"btn",disabled:"ACCEPTED"!==b.status,onClick:()=>X(b.id,"arrived"),children:"Llegu\xe9"}),a.jsx("button",{className:"btn",disabled:!("ACCEPTED"===b.status||"ARRIVED"===b.status),onClick:()=>X(b.id,"start"),children:"Iniciar"}),a.jsx("button",{className:"btn",disabled:"STARTED"!==b.status,onClick:()=>X(b.id,"complete"),children:"Completar"}),"ASSIGNED"===b.status&&a.jsx("button",{className:"btn danger",onClick:()=>X(b.id,"reject"),children:"Rechazar"})]})]}):a.jsx("div",{className:"muted",style:{marginTop:8},children:"Sin viaje activo asignado."})]})]})}function u(e){if(!e)return"#";let t=`${encodeURIComponent(e.lat)},${encodeURIComponent(e.lng)}`;return`https://www.google.com/maps/dir/?api=1&destination=${t}`}function h(e){if(!e)return"#";let t=`${encodeURIComponent(e.lat)},${encodeURIComponent(e.lng)}`;return`http://maps.apple.com/?daddr=${t}`}async function p(e){let t=(0,l.oC)();if(!t)return{feeUsd:0,graceRemainingSec:null};let n=await fetch(`http://localhost:8081/trips/${encodeURIComponent(e)}/cancel/quote`,{headers:{Authorization:`Bearer ${t}`},cache:"no-store"});if(!n.ok)return{feeUsd:0,graceRemainingSec:null};let a=await n.json();return{feeUsd:Number(a.feeUsd||0),graceRemainingSec:"number"==typeof a.graceRemainingSec?a.graceRemainingSec:null}}function m({selected:e,driverLoc:t}){let n=e=>e*Math.PI/180,r=(e,t)=>{if(!e||!t)return null;let a=n(t.lat-e.lat),r=n(t.lng-e.lng),s=Math.sin(a/2)**2+Math.cos(n(e.lat))*Math.cos(n(t.lat))*Math.sin(r/2)**2;return 2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s))*6371},s={lat:Number(e.pickupLat),lng:Number(e.pickupLng)},i={lat:Number(e.dropoffLat),lng:Number(e.dropoffLng)},l=t?r(t,s):null,c=r(s,i);return(0,a.jsxs)("div",{className:"muted",style:{marginTop:6},children:[null!=l&&(0,a.jsxs)("span",{children:["Hacia recogida: ",l.toFixed(2)," km • ~",null==l?null:Math.round(l/28*60)," min. "]}),null!=c&&(0,a.jsxs)("span",{children:["Trayecto: ",c.toFixed(2)," km • ~",null==c?null:Math.round(c/28*60)," min."]})]})}},2326:(e,t,n)=>{"use strict";n.d(t,{ik:()=>s,qM:()=>r});var a=n(326);function r({height:e=16,width:t="100%",style:n,className:r}){return a.jsx("div",{className:r,style:{height:e,width:t,background:"linear-gradient(90deg, rgba(255,255,255,0.06) 25%, rgba(255,255,255,0.12) 37%, rgba(255,255,255,0.06) 63%)",backgroundSize:"400% 100%",animation:"skeleton 1.2s ease-in-out infinite",borderRadius:8,...n}})}function s({lines:e=3}){return a.jsx("div",{className:"row",style:{gap:8,flexDirection:"column"},children:Array.from({length:e}).map((e,t)=>a.jsx(r,{height:12,width:`${80-8*t}%`},t))})}n(7577)},8069:(e,t,n)=>{"use strict";n.d(t,{S:()=>a,j:()=>r});let a="http://localhost:8081";async function r(e,t={},n){let r=new Headers(t.headers||{});r.set("Content-Type","application/json"),n&&r.set("Authorization",`Bearer ${n}`);let s=await fetch(`${a}${e}`,{...t,headers:r,cache:"no-store"});if(!s.ok){let e=await s.text().catch(()=>"");throw Error(`API ${s.status}: ${e||s.statusText}`)}return s.json()}},2305:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>a});let a=(0,n(8570).createProxy)(String.raw`/app/src/app/driver/page.tsx#default`)}};var t=require("../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),a=t.X(0,[555,791],()=>n(4965));module.exports=a})();